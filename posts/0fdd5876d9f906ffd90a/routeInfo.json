{"template":"__react_static_root__/src/components/QiitaPost","sharedHashesByProp":{},"data":{"post":{"rendered_body":"\n<h1>\n<span id=\"api-gatewayとjsonサーバーで動的htmlレンダリングしてみた\" class=\"fragment\"></span><a href=\"#api-gateway%E3%81%A8json%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%81%A7%E5%8B%95%E7%9A%84html%E3%83%AC%E3%83%B3%E3%83%80%E3%83%AA%E3%83%B3%E3%82%B0%E3%81%97%E3%81%A6%E3%81%BF%E3%81%9F\"><i class=\"fa fa-link\"></i></a>API GatewayとJSONサーバーで動的htmlレンダリングしてみた。</h1>\n\n<p>AWSのAPI GatewayとDynamoDBとLambdaでサービス構築してみたかった動機があったので、今回はAPI Gatewayを触ってみた。</p>\n\n<ul>\n<li>特定URLにWebブラウザでアクセスする</li>\n<li>API GatewayがJSONデータを取得して、htmlにレンダリングして表示する</li>\n</ul>\n\n<p>というシンプルな構造です。</p>\n\n<p>今回はやらないが、API Gatewayは統合リクエストなどの機能を使えばLambdaを挟まなくてもDynamoDBにアクセスできます。なので、 <code>/1</code> にアクセスするとDynamoDBのあるテーブルの <code>id 1</code> にアクセスして必要なデータをJSON形式で取得して、そのデータをAPIGatewayの統合レスポンスでhtmlにマッピングして返す、みたいな簡単なWEBアプリケーションが作れます。その触りだけ書いて行きます。</p>\n\n<h2>\n<span id=\"やりかた\" class=\"fragment\"></span><a href=\"#%E3%82%84%E3%82%8A%E3%81%8B%E3%81%9F\"><i class=\"fa fa-link\"></i></a>やりかた</h2>\n\n<p>REST APIとかで作る。</p>\n\n<p><a href=\"https://camo.qiitausercontent.com/855da9fa14373cfce5ba4a2da6135974c8f1b3ae/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3131323932392f32333238396265382d363931332d363964362d343838352d6436613030326339363133312e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img width=\"1109\" alt=\"スクリーンショット 2020-05-14 5.12.04.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F112929%2F23289be8-6913-69d6-4885-d6a002c96131.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=2cd6b00a95f37fc9418ad90b1aac0fb1\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/23289be8-6913-69d6-4885-d6a002c96131.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F112929%2F23289be8-6913-69d6-4885-d6a002c96131.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=3ecfaba59774788dc3cc3ac3d76fa198 1x\" loading=\"lazy\"></a></p>\n\n<p>こんな感じで適当に作り</p>\n\n<p><a href=\"https://camo.qiitausercontent.com/b0f284f74ce457f96b3b4f7e238608a16f5120d1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3131323932392f61656563363439302d303064342d306439652d383462322d6464396237653634653838612e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img width=\"1287\" alt=\"スクリーンショット 2020-05-14 5.12.37.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F112929%2Faeec6490-00d4-0d9e-84b2-dd9b7e64e88a.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=8f4dacec16f7424f7fdb7f60bdbabe07\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/aeec6490-00d4-0d9e-84b2-dd9b7e64e88a.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F112929%2Faeec6490-00d4-0d9e-84b2-dd9b7e64e88a.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=b1f067c7c236c2cf0d5409a34465cb00 1x\" loading=\"lazy\"></a></p>\n\n<p>GETメソッドを追加する</p>\n\n<p><a href=\"https://camo.qiitausercontent.com/a65642ae8b51848703495dcb56403641b61c2242/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3131323932392f38633237633366352d396263362d653838302d313562362d3330346539353065643630612e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img width=\"894\" alt=\"スクリーンショット 2020-05-14 5.13.08.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F112929%2F8c27c3f5-9bc6-e880-15b6-304e950ed60a.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=ac389a2ba5b27129bb9bc6adcfd54e49\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/8c27c3f5-9bc6-e880-15b6-304e950ed60a.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F112929%2F8c27c3f5-9bc6-e880-15b6-304e950ed60a.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=386f67aa56511eb2c35334179c840cd3 1x\" loading=\"lazy\"></a></p>\n\n<p>エンドポイントに <a href=\"https://jsondata.okiba.me/v1/json/PiWpM200513171710\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\">https://jsondata.okiba.me/v1/json/PiWpM200513171710</a> みたいなJSONを返してくれるURLをいれる。Lambdaとかに接続させてもいいがその場合は <code>AWSサービス</code> を選びゴニョゴニョしてください。後ほど書きますがMockだと、統合レスポンスでマッピングできなくてハマります。</p>\n\n<p>今回の帰ってくるデータはこれ</p>\n\n<div class=\"code-frame\" data-lang=\"json\"><div class=\"highlight\"><pre><code><span class=\"p\">{</span><span class=\"w\">\n  </span><span class=\"nl\">\"statusCode\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">200</span><span class=\"p\">,</span><span class=\"w\"> \n  </span><span class=\"nl\">\"body\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\">\n    </span><span class=\"p\">{</span><span class=\"w\">\n      </span><span class=\"nl\">\"id\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\">\n      </span><span class=\"nl\">\"name\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"JavaScript\"</span><span class=\"p\">,</span><span class=\"w\">\n      </span><span class=\"nl\">\"tel\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"08000000000\"</span><span class=\"w\">\n    </span><span class=\"p\">},</span><span class=\"w\">\n    </span><span class=\"p\">{</span><span class=\"w\">\n      </span><span class=\"nl\">\"id\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\">\n      </span><span class=\"nl\">\"name\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"Object\"</span><span class=\"p\">,</span><span class=\"w\">\n      </span><span class=\"nl\">\"tel\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"09000000000\"</span><span class=\"w\">\n    </span><span class=\"p\">},</span><span class=\"w\">\n    </span><span class=\"p\">{</span><span class=\"w\">\n      </span><span class=\"nl\">\"id\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"w\">\n      </span><span class=\"nl\">\"name\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"Node\"</span><span class=\"p\">,</span><span class=\"w\">\n      </span><span class=\"nl\">\"tel\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s2\">\"07000000000\"</span><span class=\"w\">\n    </span><span class=\"p\">}</span><span class=\"w\">\n  </span><span class=\"p\">]</span><span class=\"w\">\n</span><span class=\"p\">}</span><span class=\"w\">\n</span></code></pre></div></div>\n\n<p><a href=\"https://camo.qiitausercontent.com/b15e8e46755971e942053d9461296af1af90985a/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3131323932392f36613430306263622d313937362d643434362d383732362d3630306366326462356534352e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img width=\"1107\" alt=\"スクリーンショット 2020-05-14 5.13.47.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F112929%2F6a400bcb-1976-d446-8726-600cf2db5e45.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=f331b304ae46cae1d7d55a9c0ce81536\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/6a400bcb-1976-d446-8726-600cf2db5e45.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F112929%2F6a400bcb-1976-d446-8726-600cf2db5e45.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=e322088dd2601ccb6f670e596f65d5a1 1x\" loading=\"lazy\"></a></p>\n\n<p>次はここの <code>メソッドレスポンス</code> と <code>統合レスポンス</code> をいじる。</p>\n\n<p><a href=\"https://camo.qiitausercontent.com/65c168fa84d49840c6afadcef7b41930a13b3fdd/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3131323932392f65306163393931632d366534662d656465332d306363322d6132393664616661313739642e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img width=\"1085\" alt=\"スクリーンショット 2020-05-14 5.44.49.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F112929%2Fe0ac991c-6e4f-ede3-0cc2-a296dafa179d.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=827b28d91245fd1b48102a918679659f\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/e0ac991c-6e4f-ede3-0cc2-a296dafa179d.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F112929%2Fe0ac991c-6e4f-ede3-0cc2-a296dafa179d.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=55a89622200ac0f42d04eaf1e1402121 1x\" loading=\"lazy\"></a></p>\n\n<p>メソッドレスポンスで <code>200</code> のステータスで <code>text/html</code> がブラウザに帰るように設定する。<br>\nこのあたりの <code>application/json</code> を <code>text/html</code> に変えたらおｋ。</p>\n\n<p><a href=\"https://camo.qiitausercontent.com/12d9a201a77702bf68c605f8c736889313d29fc1/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3131323932392f66333664343433652d323333662d356233642d373537312d3230663866646332336135642e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img width=\"930\" alt=\"スクリーンショット 2020-05-14 5.48.26.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F112929%2Ff36d443e-233f-5b3d-7571-20f8fdc23a5d.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=81ef8cbab46c1d0e5ada1247ea663056\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/f36d443e-233f-5b3d-7571-20f8fdc23a5d.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F112929%2Ff36d443e-233f-5b3d-7571-20f8fdc23a5d.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=d1caedd4190ee451ee4a6c3e17d2435b 1x\" loading=\"lazy\"></a></p>\n\n<p>次は統合レスポンスですが、これもこのあたりの <code>application/json</code> を <code>text/html</code> に変えたらおｋ。<br>\n<a href=\"https://jsondata.okiba.me/v1/json/PiWpM200513171710\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\">https://jsondata.okiba.me/v1/json/PiWpM200513171710</a> が200を返したときの処理しか書いてないが一旦これでOK</p>\n\n<p><a href=\"https://camo.qiitausercontent.com/1198c5d5695c8fcde1a495ecc5f258ad174ca42c/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3131323932392f31366332613032612d383862332d613162322d623861312d3765383665396465393063642e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img width=\"952\" alt=\"スクリーンショット 2020-05-14 5.49.48.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F112929%2F16c2a02a-88b3-a1b2-b8a1-7e86e9de90cd.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=33d5b88a7f4d8e0e19b7dea869a4f388\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/16c2a02a-88b3-a1b2-b8a1-7e86e9de90cd.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F112929%2F16c2a02a-88b3-a1b2-b8a1-7e86e9de90cd.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=a8b05161204761d685cd1d3595bbd46a 1x\" loading=\"lazy\"></a></p>\n\n<div class=\"code-frame\" data-lang=\"html\"><div class=\"highlight\"><pre><code>#set($inputRoot = $input.path('$.body'))\n\n<span class=\"cp\">&lt;!DOCTYPE html&gt;</span>\n<span class=\"nt\">&lt;html</span> <span class=\"na\">lang=</span><span class=\"s\">\"ja\"</span><span class=\"nt\">&gt;</span>\n    <span class=\"nt\">&lt;head&gt;</span>\n        <span class=\"nt\">&lt;meta</span> <span class=\"na\">charset=</span><span class=\"s\">\"UTF-8\"</span> <span class=\"nt\">/&gt;</span>\n        <span class=\"nt\">&lt;meta</span> <span class=\"na\">name=</span><span class=\"s\">\"viewport\"</span> <span class=\"na\">content=</span><span class=\"s\">\"width=device-width, initial-scale=1.0\"</span> <span class=\"nt\">/&gt;</span>\n        <span class=\"nt\">&lt;link</span>\n            <span class=\"na\">rel=</span><span class=\"s\">\"stylesheet\"</span>\n            <span class=\"na\">href=</span><span class=\"s\">\"https://cdn.jsdelivr.net/gh/kognise/water.css@latest/dist/light.min.css\"</span>\n        <span class=\"nt\">/&gt;</span>\n        <span class=\"nt\">&lt;title&gt;</span>API Gateway<span class=\"nt\">&lt;/title&gt;</span>\n    <span class=\"nt\">&lt;/head&gt;</span>\n    <span class=\"nt\">&lt;body&gt;</span>\n        <span class=\"nt\">&lt;h1&gt;</span>Qiitaテスト<span class=\"nt\">&lt;/h1&gt;</span>\n        <span class=\"nt\">&lt;table</span> <span class=\"na\">border=</span><span class=\"s\">\"1\"</span><span class=\"nt\">&gt;</span>\n            <span class=\"nt\">&lt;tr&gt;</span>\n                <span class=\"nt\">&lt;td&gt;</span>id<span class=\"nt\">&lt;/td&gt;</span>\n                <span class=\"nt\">&lt;td&gt;</span>name<span class=\"nt\">&lt;/td&gt;</span>\n                <span class=\"nt\">&lt;td&gt;</span>tel<span class=\"nt\">&lt;/td&gt;</span>\n            <span class=\"nt\">&lt;/tr&gt;</span>\n            #foreach($elem in $inputRoot)\n            <span class=\"nt\">&lt;tr&gt;</span>\n                <span class=\"nt\">&lt;td&gt;</span>$elem.id<span class=\"nt\">&lt;/td&gt;</span>\n                <span class=\"nt\">&lt;td&gt;</span>$elem.name<span class=\"nt\">&lt;/td&gt;</span>\n                <span class=\"nt\">&lt;td&gt;</span>$elem.tel<span class=\"nt\">&lt;/td&gt;</span>\n            <span class=\"nt\">&lt;/tr&gt;</span>\n            #end\n        <span class=\"nt\">&lt;/table&gt;</span>\n    <span class=\"nt\">&lt;/body&gt;</span>\n<span class=\"nt\">&lt;/html&gt;</span>\n</code></pre></div></div>\n\n<p>マッピングはVTLという名前のテンプレートエンジン？<br>\n<a href=\"https://docs.aws.amazon.com/ja_jp/apigateway/latest/developerguide/api-gateway-mapping-template-reference.html\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\">https://docs.aws.amazon.com/ja_jp/apigateway/latest/developerguide/api-gateway-mapping-template-reference.html</a></p>\n\n<div class=\"code-frame\" data-lang=\"html\"><div class=\"highlight\"><pre><code>#foreach($elem in $inputRoot)\n<span class=\"nt\">&lt;tr&gt;</span>\n    <span class=\"nt\">&lt;td&gt;</span>$elem.id<span class=\"nt\">&lt;/td&gt;</span>\n    <span class=\"nt\">&lt;td&gt;</span>$elem.name<span class=\"nt\">&lt;/td&gt;</span>\n    <span class=\"nt\">&lt;td&gt;</span>$elem.tel<span class=\"nt\">&lt;/td&gt;</span>\n<span class=\"nt\">&lt;/tr&gt;</span>\n#end\n</code></pre></div></div>\n\n<p>で、一個前の画面に戻っての <code>テスト⚡</code> </p>\n\n<p><a href=\"https://camo.qiitausercontent.com/eb7bcb86c26cc78871ed38824105dc0f3ea4621b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3131323932392f38656462653634392d323261392d393232382d333061622d6430353032366331666536322e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img width=\"1085\" alt=\"スクリーンショット 2020-05-14 5.44.49.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F112929%2F8edbe649-22a9-9228-30ab-d05026c1fe62.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=1f8244be59f3a6fca98ab5ceaeedbf02\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/8edbe649-22a9-9228-30ab-d05026c1fe62.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F112929%2F8edbe649-22a9-9228-30ab-d05026c1fe62.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=4cbe56f35130a86ff3ef19d92b1f2802 1x\" loading=\"lazy\"></a></p>\n\n<p>テストとかぽちぽちしてると、ちゃんとhtmlが帰ってくれるならおｋ。</p>\n\n<p><a href=\"https://camo.qiitausercontent.com/96c5461e4ffd4c061e381cbbac516c9e162e5992/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3131323932392f39373232366361362d656439362d323865622d666263312d3333343130346563643563322e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img width=\"947\" alt=\"スクリーンショット 2020-05-14 5.55.08.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F112929%2F97226ca6-ed96-28eb-fbc1-334104ecd5c2.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=5dc23304717820f2c9e0e15d9e9069d2\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/97226ca6-ed96-28eb-fbc1-334104ecd5c2.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F112929%2F97226ca6-ed96-28eb-fbc1-334104ecd5c2.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=a02e5078e0193d720cbf614d9e9078c5 1x\" loading=\"lazy\"></a></p>\n\n<p>APIのデプロイして、誰でもアクセスできるようにして、ステージ名は適当に <code>develop</code> とか <code>stage</code> とかでいいと思う。</p>\n\n<p><a href=\"https://camo.qiitausercontent.com/8d3c2b4e31f04c7eb214784f99a086f63c74609b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3131323932392f64643232333934662d636264662d666337372d333834612d3630643135653761343438332e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img width=\"512\" alt=\"スクリーンショット 2020-05-14 5.56.01.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F112929%2Fdd22394f-cbdf-fc77-384a-60d15e7a4483.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=5e29550b89a8e93fbf144ec69b49cf77\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/dd22394f-cbdf-fc77-384a-60d15e7a4483.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F112929%2Fdd22394f-cbdf-fc77-384a-60d15e7a4483.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=de812b4579ccde6b551c7bccaf031726 1x\" loading=\"lazy\"></a></p>\n\n<p><qiita-embed-ogp src=\"https://XXXXXXXXXXXXXX.execute-api.ap-northeast-1.amazonaws.com/stage\"></qiita-embed-ogp></p>\n\n<p>みたいなURLが発行されて完了です。</p>\n\n<p><a href=\"https://camo.qiitausercontent.com/fdd9603b33d4e84863814f08fb243768b436f21b/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3131323932392f61376365666434632d363733392d386263362d633136612d3637663230346434313933322e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img width=\"1217\" alt=\"スクリーンショット 2020-05-14 5.57.52.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F112929%2Fa7cefd4c-6739-8bc6-c16a-67f204d41932.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=f8d12610c362dce38ed56e22effa7de0\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/a7cefd4c-6739-8bc6-c16a-67f204d41932.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F112929%2Fa7cefd4c-6739-8bc6-c16a-67f204d41932.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=5be3f1b698ac3ea3259a61f7e63cf1b5 1x\" loading=\"lazy\"></a></p>\n\n<h2>\n<span id=\"mockを統合レスポンスで使おうとしてハマった話\" class=\"fragment\"></span><a href=\"#mock%E3%82%92%E7%B5%B1%E5%90%88%E3%83%AC%E3%82%B9%E3%83%9D%E3%83%B3%E3%82%B9%E3%81%A7%E4%BD%BF%E3%81%8A%E3%81%86%E3%81%A8%E3%81%97%E3%81%A6%E3%83%8F%E3%83%9E%E3%81%A3%E3%81%9F%E8%A9%B1\"><i class=\"fa fa-link\"></i></a>Mockを統合レスポンスで使おうとしてハマった話</h2>\n\n<p><a href=\"https://camo.qiitausercontent.com/ab7dadcdc3da000ba4120ca245956c9425827f49/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3131323932392f36373230376431362d623236372d333735652d616165642d3962383862336435653533302e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img width=\"940\" alt=\"スクリーンショット 2020-05-14 2.07.22.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F112929%2F67207d16-b267-375e-aaed-9b88b3d5e530.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=6dc12c2d268c5eb0a9499408bcc8a85d\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/67207d16-b267-375e-aaed-9b88b3d5e530.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F112929%2F67207d16-b267-375e-aaed-9b88b3d5e530.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=190f5f67239bf7a196466bbf097f1c72 1x\" loading=\"lazy\"></a></p>\n\n<p>絵でいうとここが <code>$input.json('$')</code> が使えなかったので2週間くらいハマってました（途中でこころ折れたりしながらの二週間）</p>\n\n<p>スタック・オーバーフローに <a href=\"https://stackoverflow.com/questions/47918477/aws-api-gateway-use-mock-integration-to-echo-response-body\" rel=\"nofollow noopener\" target=\"_blank\">書いて</a>ました。</p>\n\n<p>以前 <a href=\"https://qiita.com/ykhirao/items/a41322085ab55837b88e\" id=\"reference-ae3c3946afce091a3365\">JSONを返す無料APIを3分で作る方法</a> を書きましたが、今回は <a href=\"https://jsondata.okiba.me/\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\">https://jsondata.okiba.me/</a> さんを使わせてもらいました。リクエストを噛まさずにAWSサービス内で完結させようと思ってのMOCKでしたが見事にハマりました。</p>\n\n<p><qiita-embed-ogp src=\"https://jsondata.okiba.me/v1/json/PiWpM200513171710\"></qiita-embed-ogp></p>\n","body":"# API GatewayとJSONサーバーで動的htmlレンダリングしてみた。\n\nAWSのAPI GatewayとDynamoDBとLambdaでサービス構築してみたかった動機があったので、今回はAPI Gatewayを触ってみた。\n\n- 特定URLにWebブラウザでアクセスする\n- API GatewayがJSONデータを取得して、htmlにレンダリングして表示する\n\nというシンプルな構造です。\n\n今回はやらないが、API Gatewayは統合リクエストなどの機能を使えばLambdaを挟まなくてもDynamoDBにアクセスできます。なので、 `/1` にアクセスするとDynamoDBのあるテーブルの `id 1` にアクセスして必要なデータをJSON形式で取得して、そのデータをAPIGatewayの統合レスポンスでhtmlにマッピングして返す、みたいな簡単なWEBアプリケーションが作れます。その触りだけ書いて行きます。\n\n## やりかた\n\nREST APIとかで作る。\n\n<img width=\"1109\" alt=\"スクリーンショット 2020-05-14 5.12.04.png\" src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/23289be8-6913-69d6-4885-d6a002c96131.png\">\n\nこんな感じで適当に作り\n\n<img width=\"1287\" alt=\"スクリーンショット 2020-05-14 5.12.37.png\" src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/aeec6490-00d4-0d9e-84b2-dd9b7e64e88a.png\">\n\nGETメソッドを追加する\n\n<img width=\"894\" alt=\"スクリーンショット 2020-05-14 5.13.08.png\" src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/8c27c3f5-9bc6-e880-15b6-304e950ed60a.png\">\n\nエンドポイントに https://jsondata.okiba.me/v1/json/PiWpM200513171710 みたいなJSONを返してくれるURLをいれる。Lambdaとかに接続させてもいいがその場合は `AWSサービス` を選びゴニョゴニョしてください。後ほど書きますがMockだと、統合レスポンスでマッピングできなくてハマります。\n\n今回の帰ってくるデータはこれ\n\n```json\n{\n  \"statusCode\": 200, \n  \"body\": [\n    {\n      \"id\": 1,\n      \"name\": \"JavaScript\",\n      \"tel\": \"08000000000\"\n    },\n    {\n      \"id\": 2,\n      \"name\": \"Object\",\n      \"tel\": \"09000000000\"\n    },\n    {\n      \"id\": 3,\n      \"name\": \"Node\",\n      \"tel\": \"07000000000\"\n    }\n  ]\n}\n```\n\n<img width=\"1107\" alt=\"スクリーンショット 2020-05-14 5.13.47.png\" src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/6a400bcb-1976-d446-8726-600cf2db5e45.png\">\n\n次はここの `メソッドレスポンス` と `統合レスポンス` をいじる。\n\n<img width=\"1085\" alt=\"スクリーンショット 2020-05-14 5.44.49.png\" src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/e0ac991c-6e4f-ede3-0cc2-a296dafa179d.png\">\n\nメソッドレスポンスで `200` のステータスで `text/html` がブラウザに帰るように設定する。\nこのあたりの `application/json` を `text/html` に変えたらおｋ。\n\n<img width=\"930\" alt=\"スクリーンショット 2020-05-14 5.48.26.png\" src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/f36d443e-233f-5b3d-7571-20f8fdc23a5d.png\">\n\n次は統合レスポンスですが、これもこのあたりの `application/json` を `text/html` に変えたらおｋ。\nhttps://jsondata.okiba.me/v1/json/PiWpM200513171710 が200を返したときの処理しか書いてないが一旦これでOK\n\n\n<img width=\"952\" alt=\"スクリーンショット 2020-05-14 5.49.48.png\" src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/16c2a02a-88b3-a1b2-b8a1-7e86e9de90cd.png\">\n\n\n```html\n#set($inputRoot = $input.path('$.body'))\n\n<!DOCTYPE html>\n<html lang=\"ja\">\n    <head>\n        <meta charset=\"UTF-8\" />\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\" />\n        <link\n            rel=\"stylesheet\"\n            href=\"https://cdn.jsdelivr.net/gh/kognise/water.css@latest/dist/light.min.css\"\n        />\n        <title>API Gateway</title>\n    </head>\n    <body>\n        <h1>Qiitaテスト</h1>\n        <table border=\"1\">\n            <tr>\n                <td>id</td>\n                <td>name</td>\n                <td>tel</td>\n            </tr>\n            #foreach($elem in $inputRoot)\n            <tr>\n                <td>$elem.id</td>\n                <td>$elem.name</td>\n                <td>$elem.tel</td>\n            </tr>\n            #end\n        </table>\n    </body>\n</html>\n```\n\nマッピングはVTLという名前のテンプレートエンジン？\nhttps://docs.aws.amazon.com/ja_jp/apigateway/latest/developerguide/api-gateway-mapping-template-reference.html\n\n```html\n#foreach($elem in $inputRoot)\n<tr>\n    <td>$elem.id</td>\n    <td>$elem.name</td>\n    <td>$elem.tel</td>\n</tr>\n#end\n```\n\nで、一個前の画面に戻っての `テスト⚡` \n\n\n<img width=\"1085\" alt=\"スクリーンショット 2020-05-14 5.44.49.png\" src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/8edbe649-22a9-9228-30ab-d05026c1fe62.png\">\n\nテストとかぽちぽちしてると、ちゃんとhtmlが帰ってくれるならおｋ。\n\n<img width=\"947\" alt=\"スクリーンショット 2020-05-14 5.55.08.png\" src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/97226ca6-ed96-28eb-fbc1-334104ecd5c2.png\">\n\nAPIのデプロイして、誰でもアクセスできるようにして、ステージ名は適当に `develop` とか `stage` とかでいいと思う。\n\n<img width=\"512\" alt=\"スクリーンショット 2020-05-14 5.56.01.png\" src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/dd22394f-cbdf-fc77-384a-60d15e7a4483.png\">\n\n\nhttps://XXXXXXXXXXXXXX.execute-api.ap-northeast-1.amazonaws.com/stage\n\nみたいなURLが発行されて完了です。\n\n<img width=\"1217\" alt=\"スクリーンショット 2020-05-14 5.57.52.png\" src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/a7cefd4c-6739-8bc6-c16a-67f204d41932.png\">\n\n\n## Mockを統合レスポンスで使おうとしてハマった話\n\n<img width=\"940\" alt=\"スクリーンショット 2020-05-14 2.07.22.png\" src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/67207d16-b267-375e-aaed-9b88b3d5e530.png\">\n\n\n絵でいうとここが `$input.json('$')` が使えなかったので2週間くらいハマってました（途中でこころ折れたりしながらの二週間）\n\nスタック・オーバーフローに [書いて](https://stackoverflow.com/questions/47918477/aws-api-gateway-use-mock-integration-to-echo-response-body)ました。\n\n以前 [JSONを返す無料APIを3分で作る方法](https://qiita.com/ykhirao/items/a41322085ab55837b88e) を書きましたが、今回は https://jsondata.okiba.me/ さんを使わせてもらいました。リクエストを噛まさずにAWSサービス内で完結させようと思ってのMOCKでしたが見事にハマりました。\n\nhttps://jsondata.okiba.me/v1/json/PiWpM200513171710\n\n","coediting":false,"comments_count":0,"created_at":"2020-05-14T05:59:27+09:00","group":null,"id":"0fdd5876d9f906ffd90a","likes_count":7,"private":false,"reactions_count":0,"stocks_count":5,"tags":[{"name":"AWS","versions":[]},{"name":"API","versions":[]},{"name":"APIGateway","versions":[]}],"title":"[AWS] API GatewayとJSONサーバーで動的htmlレンダリングしてみた。","updated_at":"2020-05-14T06:00:17+09:00","url":"https://qiita.com/ykhirao/items/0fdd5876d9f906ffd90a","user":{"description":"Web Developer From 2016.\r\nPHP/Laravel && React/TypeScript/Node.js\r\n\r\n業務委託の依頼とかはWantedlyとかからでお願いします！","facebook_id":"","followees_count":38,"followers_count":98,"github_login_name":"ykhirao","id":"ykhirao","items_count":68,"linkedin_id":"","location":"Tokyo, Japan","name":"yk","organization":"","permanent_id":112929,"profile_image_url":"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/profile-images/1639030792","team_only":false,"twitter_screen_name":"ykhirao","website_url":"https://www.wantedly.com/id/ykhirao"},"page_views_count":null,"team_membership":null,"organization_url_name":null}},"path":"posts/0fdd5876d9f906ffd90a"}
