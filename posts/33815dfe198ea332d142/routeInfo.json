{"template":"__react_static_root__/src/components/QiitaPost","sharedHashesByProp":{},"data":{"post":{"rendered_body":"<p>こんにちは。年末年始はずっとFirebaseを触っていました <a href=\"/ykhirao\" class=\"user-mention js-hovercard\" title=\"ykhirao\" data-hovercard-target-type=\"user\" data-hovercard-target-name=\"ykhirao\">@ykhirao</a> です。たぶん3年くらい遅れて流行に乗り始めています。Typescriptお正月にはじめました。</p>\n\n<p>今日は、仕事がお休みなのでスマホぽちぽちしていたらすごく参考になる記事を見かけましたのですが、こちらの記事 <a href=\"https://tech.appbrew.io/entry/2020/01/15/120000\" rel=\"nofollow noopener\" target=\"_blank\">Firebaseで作る！リアルタイム画像変換CDN【Firebase Hosting + Cloud Functions】 - AppBrew Tech Blog</a> で書かれている <code>アップロードされた画像をそのまま表示する時代は平成とともに終わりを告げたわけですが[※要出典]</code> という文言を見てくすっと笑ってしまい、少し前に <a href=\"https://qiita.com/hecateball/items/c55b6811835923fb9574\">君はまだ平成のアーキテクチャを使ってるのか？僕はFirebaseと令和の時代に行くぞ。</a> という記事がたくさんの方に読まれていたこととか、Twitterの擬人化された <a href=\"https://twitter.com/search?q=%23%E4%BB%A4%E5%92%8C%E3%81%A1%E3%82%83%E3%82%93\" rel=\"nofollow noopener\" target=\"_blank\">#令和ちゃん</a> を思い出したりして、エンジニアのみなさんは令和ちゃんもFirebaseも大好きっぽいので私も記事を書こうかなーーと思って書き始めました。ネタなんだけど誰かの役にたつ記事を書きたい次第です。</p>\n\n<p>さて前置きが長くなりましたが、本文は、画像をアップロードする前にゴリッと処理する方法を書いて行きます。</p>\n\n<h1>\n<span id=\"画像をアップロード前に圧縮する流行りの方法\" class=\"fragment\"></span><a href=\"#%E7%94%BB%E5%83%8F%E3%82%92%E3%82%A2%E3%83%83%E3%83%97%E3%83%AD%E3%83%BC%E3%83%89%E5%89%8D%E3%81%AB%E5%9C%A7%E7%B8%AE%E3%81%99%E3%82%8B%E6%B5%81%E8%A1%8C%E3%82%8A%E3%81%AE%E6%96%B9%E6%B3%95\"><i class=\"fa fa-link\"></i></a>画像をアップロード前に圧縮する流行りの方法</h1>\n\n<h2>\n<span id=\"今回紹介することしないこと\" class=\"fragment\"></span><a href=\"#%E4%BB%8A%E5%9B%9E%E7%B4%B9%E4%BB%8B%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8%E3%81%97%E3%81%AA%E3%81%84%E3%81%93%E3%81%A8\"><i class=\"fa fa-link\"></i></a>今回紹介すること、しないこと</h2>\n\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre><code># 画像アップロードについての手法\n\n1. 画像処理をしない(平成)\n\n2. 画像処理をする(令和)\n  - 2.1 サーバーで処理する (https://tech.appbrew.io/entry/2020/01/15/120000 で紹介されている)\n    - Firebase Extension（まだβっぽいですが公式の拡張があるっぽい！）\n    - CloudFunctionsを自分でNode.JSごりごり書く\n  - 2.2 クライアント側で処理する( &lt;---- 今日の記事はここ！！！)\n</code></pre></div></div>\n\n<h2>\n<span id=\"本文いらないからスクショとかgistみたいひと\" class=\"fragment\"></span><a href=\"#%E6%9C%AC%E6%96%87%E3%81%84%E3%82%89%E3%81%AA%E3%81%84%E3%81%8B%E3%82%89%E3%82%B9%E3%82%AF%E3%82%B7%E3%83%A7%E3%81%A8%E3%81%8Bgist%E3%81%BF%E3%81%9F%E3%81%84%E3%81%B2%E3%81%A8\"><i class=\"fa fa-link\"></i></a>本文いらないからスクショとかGistみたいひと</h2>\n\n<p>以下のスクショのようになるGistはこちら<br>\n<a href=\"https://gist.github.com/ykhirao/1d36aeca9abb02709cc9dd3d676040ef\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\">https://gist.github.com/ykhirao/1d36aeca9abb02709cc9dd3d676040ef</a></p>\n\n<p><a href=\"https://camo.qiitausercontent.com/6b6c597a98d947ee94c260fa4d55bd4436205254/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3131323932392f62313533373531372d656334342d663962302d336632342d3066393962376365613434612e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img width=\"1672\" alt=\"スクリーンショット 2020-01-16 13.32.29.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F112929%2Fb1537517-ec44-f9b0-3f24-0f99b7cea44a.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=69b617e8b6520c467cfa27db3dd124bb\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/b1537517-ec44-f9b0-3f24-0f99b7cea44a.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F112929%2Fb1537517-ec44-f9b0-3f24-0f99b7cea44a.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=5ccaf52e4a792a625b9688b420bd8c1b 1x\" loading=\"lazy\"></a></p>\n\n<p><a href=\"https://camo.qiitausercontent.com/affbbab7aafe55e01f7105f920d83748d3a2df4f/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3131323932392f64366437663039642d666463362d343739612d336639362d3765396137313236306265322e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img width=\"1330\" alt=\"スクリーンショット 2020-01-16 14.17.23.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F112929%2Fd6d7f09d-fdc6-479a-3f96-7e9a71260be2.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=1570a6f782c256deaa732bd20c2fb778\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/d6d7f09d-fdc6-479a-3f96-7e9a71260be2.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F112929%2Fd6d7f09d-fdc6-479a-3f96-7e9a71260be2.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=e34da2ce6e6f65476da3ca294eaa1aa1 1x\" loading=\"lazy\"></a></p>\n\n<p>(最大 100x100 px にしているので2kbくらい)</p>\n\n<h2>\n<span id=\"処理して簡単に解説する\" class=\"fragment\"></span><a href=\"#%E5%87%A6%E7%90%86%E3%81%97%E3%81%A6%E7%B0%A1%E5%8D%98%E3%81%AB%E8%A7%A3%E8%AA%AC%E3%81%99%E3%82%8B\"><i class=\"fa fa-link\"></i></a>処理して簡単に解説する</h2>\n\n<p><a href=\"https://qiita.com/komakomako/items/8efd4184f6d7cf1363f2\" id=\"reference-70c300a4799183af61fb\">Canvasでごりっと処理する</a>とか、ライブラリに頼るとか方法はあると思いますが今回は <a href=\"https://github.com/fengyuanchen/compressorjs\" rel=\"nofollow noopener\" target=\"_blank\">compressorjs</a> を紹介したいっす。</p>\n\n<div class=\"code-frame\" data-lang=\"javascript\">\n<div class=\"code-lang\"><span class=\"bold\">component.js</span></div>\n<div class=\"highlight\"><pre><code><span class=\"k\">import</span> <span class=\"nx\">Compressor</span> <span class=\"k\">from</span> <span class=\"dl\">'</span><span class=\"s1\">compressorjs</span><span class=\"dl\">'</span>\n</code></pre></div>\n</div>\n\n<p>OR</p>\n\n<div class=\"code-frame\" data-lang=\"html\">\n<div class=\"code-lang\"><span class=\"bold\">index.html</span></div>\n<div class=\"highlight\"><pre><code><span class=\"nt\">&lt;script </span><span class=\"na\">src=</span><span class=\"s\">\"https://cdn.jsdelivr.net/gh/fengyuanchen/compressorjs/dist/compressor.min.js\"</span><span class=\"nt\">&gt;&lt;/script&gt;</span>\n</code></pre></div>\n</div>\n\n<p>CDNはなかなか見つからなかったのですがぐぐったら <a href=\"https://paiza.hatenablog.com/entry/2019/04/03/%E7%94%BB%E5%83%8F%E5%9C%A7%E7%B8%AE%E3%82%84%E3%82%AA%E3%83%BC%E3%83%88%E3%82%B3%E3%83%B3%E3%83%97%E3%83%AA%E3%83%BC%E3%83%88%E3%81%AA%E3%81%A9Web%E9%96%8B%E7%99%BA%E3%82%92%E7%B0%A1%E5%8D%98%E3%81%AB\" rel=\"nofollow noopener\" target=\"_blank\">このブログ</a> で見つかった。まさとらんさんありがとうです。</p>\n\n<p>画像は <code>input</code> タグで選択してもらって</p>\n\n<div class=\"code-frame\" data-lang=\"js\"><div class=\"highlight\"><pre><code><span class=\"o\">&lt;</span><span class=\"nx\">input</span>\n  <span class=\"nx\">type</span><span class=\"o\">=</span><span class=\"dl\">\"</span><span class=\"s2\">file</span><span class=\"dl\">\"</span>\n  <span class=\"nx\">id</span><span class=\"o\">=</span><span class=\"dl\">\"</span><span class=\"s2\">file</span><span class=\"dl\">\"</span>\n  <span class=\"nx\">multiple</span>\n  <span class=\"nx\">accept</span><span class=\"o\">=</span><span class=\"dl\">\"</span><span class=\"s2\">image/*</span><span class=\"dl\">\"</span>\n  <span class=\"p\">@</span><span class=\"nd\">change</span><span class=\"o\">=</span><span class=\"dl\">\"</span><span class=\"s2\">handleFiles</span><span class=\"dl\">\"</span>\n<span class=\"o\">/&gt;</span>\n</code></pre></div></div>\n\n<p><code>multiple</code> で複数選択可にして <code>accept</code> で画像以外を一応弾いています。それで <code>@change</code> イベントのフックで画像を圧縮しています。</p>\n\n<div class=\"code-frame\" data-lang=\"js\"><div class=\"highlight\"><pre><code><span class=\"nx\">handleFiles</span><span class=\"p\">(</span><span class=\"nx\">e</span><span class=\"p\">:</span> <span class=\"nx\">Event</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"kd\">const</span> <span class=\"nx\">images</span> <span class=\"o\">=</span> <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">images</span>\n  <span class=\"kd\">const</span> <span class=\"nx\">files</span><span class=\"p\">:</span> <span class=\"nx\">FileList</span> <span class=\"o\">|</span> <span class=\"kc\">null</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"o\">&lt;</span><span class=\"nx\">HTMLInputElement</span><span class=\"o\">&gt;</span><span class=\"nx\">e</span><span class=\"p\">.</span><span class=\"nx\">target</span><span class=\"p\">).</span><span class=\"nx\">files</span>\n  <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nx\">files</span> <span class=\"o\">===</span> <span class=\"kc\">null</span><span class=\"p\">)</span> <span class=\"k\">return</span>\n  <span class=\"p\">;[...</span><span class=\"nx\">files</span><span class=\"p\">].</span><span class=\"nx\">forEach</span><span class=\"p\">((</span><span class=\"nx\">file</span><span class=\"p\">:</span> <span class=\"nx\">File</span><span class=\"p\">)</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n    <span class=\"c1\">// 複数ファイルを受け入れているので、この中で処理している</span>\n  <span class=\"p\">})</span>\n<span class=\"p\">}</span>\n</code></pre></div></div>\n\n<p>複数処理やfileが取得できなかった場合の処理は上のような感じで、Typescript的にエラーが出ていないのでこれでOKかなと思ってます（認識あってますか？）</p>\n\n<div class=\"code-frame\" data-lang=\"js\"><div class=\"highlight\"><pre><code><span class=\"kd\">const</span> <span class=\"nx\">payload</span><span class=\"p\">:</span> <span class=\"nx\">Compressor</span><span class=\"p\">.</span><span class=\"nx\">Options</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n  <span class=\"na\">quality</span><span class=\"p\">:</span> <span class=\"mf\">0.8</span><span class=\"p\">,</span>\n  <span class=\"na\">maxWidth</span><span class=\"p\">:</span> <span class=\"mi\">100</span><span class=\"p\">,</span>\n  <span class=\"na\">maxHeight</span><span class=\"p\">:</span> <span class=\"mi\">100</span><span class=\"p\">,</span>\n  <span class=\"na\">mimeType</span><span class=\"p\">:</span> <span class=\"dl\">'</span><span class=\"s1\">image/jpeg</span><span class=\"dl\">'</span><span class=\"p\">,</span>\n  <span class=\"nx\">success</span><span class=\"p\">(</span><span class=\"na\">blob</span><span class=\"p\">:</span> <span class=\"nx\">Blob</span><span class=\"p\">):</span> <span class=\"k\">void</span> <span class=\"p\">{</span>\n    <span class=\"c1\">// ここに成功時の処理を書く。次。</span>\n  <span class=\"p\">},</span>\n  <span class=\"nx\">error</span><span class=\"p\">(</span><span class=\"na\">err</span><span class=\"p\">:</span> <span class=\"nb\">Error</span><span class=\"p\">):</span> <span class=\"k\">void</span> <span class=\"p\">{</span>\n    <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"nx\">err</span><span class=\"p\">.</span><span class=\"nx\">message</span><span class=\"p\">)</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n<span class=\"k\">new</span> <span class=\"nx\">Compressor</span><span class=\"p\">(</span><span class=\"nx\">file</span><span class=\"p\">,</span> <span class=\"nx\">payload</span><span class=\"p\">)</span>\n</code></pre></div></div>\n\n<p>実際の処理はこんな感じで横幅・縦幅の最大とか圧縮率とかたくさんの <a href=\"https://github.com/fengyuanchen/compressorjs/blob/master/README.md#options\" rel=\"nofollow noopener\" target=\"_blank\">オプション</a> があります。また成功時と失敗時は <code>success</code> と <code>error</code> のコールバックに書くみたいです。</p>\n\n<div class=\"code-frame\" data-lang=\"js\"><div class=\"highlight\"><pre><code><span class=\"nx\">success</span><span class=\"p\">(</span><span class=\"nx\">blob</span><span class=\"p\">:</span> <span class=\"nx\">Blob</span><span class=\"p\">):</span> <span class=\"k\">void</span> <span class=\"p\">{</span>\n<span class=\"p\">},</span>\n\n</code></pre></div></div>\n\n<p>サクセスのコールバックは <code>Blob</code> を受け取るのでFirebaseではこの段階でファイルのアップロードができます！！！<a href=\"https://firebase.google.com/docs/storage/web/upload-files?hl=ja#upload_from_a_blob_or_file\" rel=\"nofollow noopener\" target=\"_blank\">ドキュメントはこちら。</a>  Blobからアップロードできるとかすごくいいですね。(試してないけどたぶんそちらでUploadできる)</p>\n\n<p>今回はアップロードする前に読み込みを確認したかったので、DataUrlという形式に変換しています。</p>\n\n<div class=\"code-frame\" data-lang=\"js\"><div class=\"highlight\"><pre><code><span class=\"nx\">success</span><span class=\"p\">(</span><span class=\"nx\">blob</span><span class=\"p\">:</span> <span class=\"nx\">Blob</span><span class=\"p\">):</span> <span class=\"k\">void</span> <span class=\"p\">{</span>\n  <span class=\"kd\">var</span> <span class=\"nx\">reader</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">FileReader</span><span class=\"p\">()</span>\n  <span class=\"nx\">reader</span><span class=\"p\">.</span><span class=\"nx\">onloadend</span> <span class=\"o\">=</span> <span class=\"p\">()</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n    <span class=\"kd\">const</span> <span class=\"nx\">result</span> <span class=\"o\">=</span> <span class=\"o\">&lt;</span><span class=\"nx\">string</span> <span class=\"o\">|</span> <span class=\"nb\">ArrayBuffer</span> <span class=\"o\">|</span> <span class=\"kc\">null</span><span class=\"o\">&gt;</span><span class=\"nx\">reader</span><span class=\"p\">.</span><span class=\"nx\">result</span>\n    <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nx\">result</span> <span class=\"k\">instanceof</span> <span class=\"nb\">ArrayBuffer</span> <span class=\"o\">||</span> <span class=\"nx\">result</span> <span class=\"o\">===</span> <span class=\"kc\">null</span><span class=\"p\">)</span> <span class=\"k\">return</span>\n    <span class=\"nx\">images</span><span class=\"p\">.</span><span class=\"nx\">push</span><span class=\"p\">(</span><span class=\"nx\">result</span><span class=\"p\">)</span>\n  <span class=\"p\">}</span>\n  <span class=\"nx\">reader</span><span class=\"p\">.</span><span class=\"nx\">readAsDataURL</span><span class=\"p\">(</span><span class=\"nx\">blob</span><span class=\"p\">)</span>\n<span class=\"p\">},</span>\n</code></pre></div></div>\n\n<p><code>images.push(result)</code> する段階でDataUrlという形式の <code>data:image/jpeg;base64,XXXXXXXX</code>みたいな文字列になっています。<a href=\"https://firebase.google.com/docs/storage/web/upload-files?hl=ja#upload_from_a_string\" rel=\"nofollow noopener\" target=\"_blank\">ドキュメントの文字列からアップロードする</a>を見ると</p>\n\n<div class=\"code-frame\" data-lang=\"js\"><div class=\"highlight\"><pre><code><span class=\"kd\">var</span> <span class=\"nx\">message</span> <span class=\"o\">=</span> <span class=\"dl\">'</span><span class=\"s1\">data:text/plain;base64,5b6p5Y+344GX44G+44GX44Gf77yB44GK44KB44Gn44Go44GG77yB</span><span class=\"dl\">'</span><span class=\"p\">;</span>\n<span class=\"nx\">ref</span><span class=\"p\">.</span><span class=\"nx\">putString</span><span class=\"p\">(</span><span class=\"nx\">message</span><span class=\"p\">,</span> <span class=\"dl\">'</span><span class=\"s1\">data_url</span><span class=\"dl\">'</span><span class=\"p\">).</span><span class=\"nx\">then</span><span class=\"p\">(</span><span class=\"kd\">function</span><span class=\"p\">(</span><span class=\"nx\">snapshot</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">Uploaded a data_url string!</span><span class=\"dl\">'</span><span class=\"p\">);</span>\n<span class=\"p\">});</span>\n</code></pre></div></div>\n\n<p>これでアップロードできそうですね。</p>\n\n<p>ドキュメントを読むと <code>data:text/plain;base64,</code> という文字列を削除したら ref.putString(message, 'base64url')でアップロードできそうです。たぶん。</p>\n\n<p>サンプルファイルは <code>&lt;script lang=\"ts\"&gt;</code> にしているのでVSCodeでひらいて、 <code>CMD + Click</code> とかで定義元とか飛んで行って自分で触ってみてください！！</p>\n\n<p><a href=\"https://camo.qiitausercontent.com/1727be86da44b5cc85c2dbae435f1b31f2af6e04/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3131323932392f38643038333739662d323139322d626266312d386238342d6437323764373361623237622e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img width=\"659\" alt=\"スクリーンショット 2020-01-16 14.09.43.png\" src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F112929%2F8d08379f-2192-bbf1-8b84-d727d73ab27b.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=c089a54495a050d153c48ddf100f248e\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/8d08379f-2192-bbf1-8b84-d727d73ab27b.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F112929%2F8d08379f-2192-bbf1-8b84-d727d73ab27b.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=14f8e46852d921d15bfacf5512470bfe 1x\" loading=\"lazy\"></a></p>\n\n<h2>\n<span id=\"終わりに\" class=\"fragment\"></span><a href=\"#%E7%B5%82%E3%82%8F%E3%82%8A%E3%81%AB\"><i class=\"fa fa-link\"></i></a>終わりに</h2>\n\n<p>ブラウザのAPIを叩くときにTypeScriptすごく開発体験良かったです。MDNを見に行かなくても何が返ってくるかわかるので、null制御とかそういうのがやりやすかったです。コード書いてて楽しかった。</p>\n\n<p>なにか間違い見つけたら編集リクエストください！！！</p>\n\n<p>最後まで読んでいただきありがとうございます。！！</p>\n","body":"こんにちは。年末年始はずっとFirebaseを触っていました @ykhirao です。たぶん3年くらい遅れて流行に乗り始めています。Typescriptお正月にはじめました。\n\n今日は、仕事がお休みなのでスマホぽちぽちしていたらすごく参考になる記事を見かけましたのですが、こちらの記事 [Firebaseで作る！リアルタイム画像変換CDN【Firebase Hosting + Cloud Functions】 - AppBrew Tech Blog](https://tech.appbrew.io/entry/2020/01/15/120000) で書かれている `アップロードされた画像をそのまま表示する時代は平成とともに終わりを告げたわけですが[※要出典]` という文言を見てくすっと笑ってしまい、少し前に [君はまだ平成のアーキテクチャを使ってるのか？僕はFirebaseと令和の時代に行くぞ。](https://qiita.com/hecateball/items/c55b6811835923fb9574) という記事がたくさんの方に読まれていたこととか、Twitterの擬人化された [#令和ちゃん](https://twitter.com/search?q=%23令和ちゃん) を思い出したりして、エンジニアのみなさんは令和ちゃんもFirebaseも大好きっぽいので私も記事を書こうかなーーと思って書き始めました。ネタなんだけど誰かの役にたつ記事を書きたい次第です。\n\n\nさて前置きが長くなりましたが、本文は、画像をアップロードする前にゴリッと処理する方法を書いて行きます。\n\n# 画像をアップロード前に圧縮する流行りの方法\n\n## 今回紹介すること、しないこと\n\n```\n# 画像アップロードについての手法\n\n1. 画像処理をしない(平成)\n\n2. 画像処理をする(令和)\n  - 2.1 サーバーで処理する (https://tech.appbrew.io/entry/2020/01/15/120000 で紹介されている)\n    - Firebase Extension（まだβっぽいですが公式の拡張があるっぽい！）\n    - CloudFunctionsを自分でNode.JSごりごり書く\n  - 2.2 クライアント側で処理する( <---- 今日の記事はここ！！！)\n```\n\n\n\n## 本文いらないからスクショとかGistみたいひと\n\n以下のスクショのようになるGistはこちら\nhttps://gist.github.com/ykhirao/1d36aeca9abb02709cc9dd3d676040ef\n\n<img width=\"1672\" alt=\"スクリーンショット 2020-01-16 13.32.29.png\" src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/b1537517-ec44-f9b0-3f24-0f99b7cea44a.png\">\n\n<img width=\"1330\" alt=\"スクリーンショット 2020-01-16 14.17.23.png\" src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/d6d7f09d-fdc6-479a-3f96-7e9a71260be2.png\">\n\n(最大 100x100 px にしているので2kbくらい)\n\n\n## 処理して簡単に解説する\n\n[Canvasでごりっと処理する](https://qiita.com/komakomako/items/8efd4184f6d7cf1363f2)とか、ライブラリに頼るとか方法はあると思いますが今回は [compressorjs](https://github.com/fengyuanchen/compressorjs) を紹介したいっす。\n\n```component.js\nimport Compressor from 'compressorjs'\n```\n\nOR\n\n```index.html\n<script src=\"https://cdn.jsdelivr.net/gh/fengyuanchen/compressorjs/dist/compressor.min.js\"></script>\n```\n\nCDNはなかなか見つからなかったのですがぐぐったら [このブログ](https://paiza.hatenablog.com/entry/2019/04/03/画像圧縮やオートコンプリートなどWeb開発を簡単に) で見つかった。まさとらんさんありがとうです。\n\n画像は `input` タグで選択してもらって\n\n```js\n<input\n  type=\"file\"\n  id=\"file\"\n  multiple\n  accept=\"image/*\"\n  @change=\"handleFiles\"\n/>\n```\n\n`multiple` で複数選択可にして `accept` で画像以外を一応弾いています。それで `@change` イベントのフックで画像を圧縮しています。\n\n```js\nhandleFiles(e: Event) {\n  const images = this.images\n  const files: FileList | null = (<HTMLInputElement>e.target).files\n  if (files === null) return\n  ;[...files].forEach((file: File) => {\n    // 複数ファイルを受け入れているので、この中で処理している\n  })\n}\n```\n\n複数処理やfileが取得できなかった場合の処理は上のような感じで、Typescript的にエラーが出ていないのでこれでOKかなと思ってます（認識あってますか？）\n\n```js\nconst payload: Compressor.Options = {\n  quality: 0.8,\n  maxWidth: 100,\n  maxHeight: 100,\n  mimeType: 'image/jpeg',\n  success(blob: Blob): void {\n    // ここに成功時の処理を書く。次。\n  },\n  error(err: Error): void {\n    console.log(err.message)\n  }\n}\nnew Compressor(file, payload)\n```\n\n実際の処理はこんな感じで横幅・縦幅の最大とか圧縮率とかたくさんの [オプション](https://github.com/fengyuanchen/compressorjs/blob/master/README.md#options) があります。また成功時と失敗時は `success` と `error` のコールバックに書くみたいです。\n\n\n```js\nsuccess(blob: Blob): void {\n},\n\n```\n\nサクセスのコールバックは `Blob` を受け取るのでFirebaseではこの段階でファイルのアップロードができます！！！[ドキュメントはこちら。](https://firebase.google.com/docs/storage/web/upload-files?hl=ja#upload_from_a_blob_or_file)  Blobからアップロードできるとかすごくいいですね。(試してないけどたぶんそちらでUploadできる)\n\n今回はアップロードする前に読み込みを確認したかったので、DataUrlという形式に変換しています。\n\n```js\nsuccess(blob: Blob): void {\n  var reader = new FileReader()\n  reader.onloadend = () => {\n    const result = <string | ArrayBuffer | null>reader.result\n    if (result instanceof ArrayBuffer || result === null) return\n    images.push(result)\n  }\n  reader.readAsDataURL(blob)\n},\n```\n\n`images.push(result)` する段階でDataUrlという形式の `data:image/jpeg;base64,XXXXXXXX`みたいな文字列になっています。[ドキュメントの文字列からアップロードする](https://firebase.google.com/docs/storage/web/upload-files?hl=ja#upload_from_a_string)を見ると\n\n```js\nvar message = 'data:text/plain;base64,5b6p5Y+344GX44G+44GX44Gf77yB44GK44KB44Gn44Go44GG77yB';\nref.putString(message, 'data_url').then(function(snapshot) {\n  console.log('Uploaded a data_url string!');\n});\n```\n\nこれでアップロードできそうですね。\n\nドキュメントを読むと `data:text/plain;base64,` という文字列を削除したら ref.putString(message, 'base64url')でアップロードできそうです。たぶん。\n\nサンプルファイルは `<script lang=\"ts\">` にしているのでVSCodeでひらいて、 `CMD + Click` とかで定義元とか飛んで行って自分で触ってみてください！！\n\n<img width=\"659\" alt=\"スクリーンショット 2020-01-16 14.09.43.png\" src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/8d08379f-2192-bbf1-8b84-d727d73ab27b.png\">\n\n## 終わりに\n\nブラウザのAPIを叩くときにTypeScriptすごく開発体験良かったです。MDNを見に行かなくても何が返ってくるかわかるので、null制御とかそういうのがやりやすかったです。コード書いてて楽しかった。\n\nなにか間違い見つけたら編集リクエストください！！！\n\n最後まで読んでいただきありがとうございます。！！\n\n\n\n\n","coediting":false,"comments_count":3,"created_at":"2020-01-16T14:21:50+09:00","group":null,"id":"33815dfe198ea332d142","likes_count":154,"private":false,"reactions_count":0,"stocks_count":144,"tags":[{"name":"JavaScript","versions":[]},{"name":"Vue.js","versions":[]},{"name":"Firebase","versions":[]},{"name":"FirebaseStorage","versions":[]}],"title":"画像をアップロード前に圧縮する流行りの方法【Vue.js x Firebase x 令和】","updated_at":"2021-10-06T21:01:55+09:00","url":"https://qiita.com/ykhirao/items/33815dfe198ea332d142","user":{"description":"Web Developer From 2016.\r\nPHP/Laravel && React/TypeScript/Node.js\r\n\r\n業務委託の依頼とかはWantedlyとかからでお願いします！","facebook_id":"","followees_count":39,"followers_count":100,"github_login_name":"ykhirao","id":"ykhirao","items_count":78,"linkedin_id":"","location":"Tokyo, Japan","name":"yk","organization":"","permanent_id":112929,"profile_image_url":"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/profile-images/1639030792","team_only":false,"twitter_screen_name":"ykhirao","website_url":"https://www.wantedly.com/id/ykhirao"},"page_views_count":null,"team_membership":null,"organization_url_name":null,"slide":false}},"path":"posts/33815dfe198ea332d142"}
