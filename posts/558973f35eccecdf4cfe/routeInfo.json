{"template":"__react_static_root__/src/components/QiitaPost","sharedHashesByProp":{},"data":{"post":{"rendered_body":"<h2 data-sourcepos=\"2:1-2:10\">\n<span id=\"mermaid\" class=\"fragment\"></span><a href=\"#mermaid\"><i class=\"fa fa-link\"></i></a>Mermaid</h2>\n<iframe id=\"qiita-embed-content__be54df2c146cc1ff1ba51d86dabde861\" src=\"https://qiita.com/embed-contents/mermaid#qiita-embed-content__be54df2c146cc1ff1ba51d86dabde861\" style=\"width:100%;\" frameborder=\"0\" scrolling=\"no\" loading=\"lazy\" data-content='{\"data\":\"sequenceDiagram\\n participant RaspberryPi as ラズベリーパイ\\n participant NodeJS as Node.js(NodeCron)\\n participant PlanetScaleDB as PlanetScaleDB\\n participant PlayWriteNodeJS as PlayWrite\\n participant TesseractJS as Tesseract.js\\n participant QiitaAPI as QiitaAPI\\n participant NtfySH as ntfy.sh\\n participant Smartphone as スマホ\\n\\n RaspberryPi -&gt;&gt; NodeJS: Foreverでデーモン化\\n NodeJS -&gt;&gt; PlanetScaleDB: 各種データはオンライン保存\\n PlanetScaleDB --&gt;&gt; NodeJS: DB確認して処理済みなら再実行\\n NodeJS -&gt;&gt; PlayWriteNodeJS: 画像を取得\\n PlayWriteNodeJS --&gt;&gt; NodeJS: 画像をダウンロード\\n NodeJS -&gt;&gt; TesseractJS: 画像をOCR解析\\n TesseractJS --&gt;&gt; NodeJS: 解析結果\\n NodeJS -&gt;&gt; QiitaAPI: ブログに投稿\\n QiitaAPI --&gt;&gt; NodeJS: URLを取得\\n NodeJS -&gt;&gt; NtfySH: スマホにブログURLを通知\\n NtfySH -&gt;&gt; Smartphone: 通知\",\"key\":\"ba128485ebf1eadccf1728d219af0489\"}'>\n</iframe>\n\n<h2 data-sourcepos=\"28:1-28:18\">\n<span id=\"簡単な解説\" class=\"fragment\"></span><a href=\"#%E7%B0%A1%E5%8D%98%E3%81%AA%E8%A7%A3%E8%AA%AC\"><i class=\"fa fa-link\"></i></a>簡単な解説</h2>\n<h3 data-sourcepos=\"30:1-30:40\">\n<span id=\"raspberrypi-as-ラズベリーパイ\" class=\"fragment\"></span><a href=\"#raspberrypi-as-%E3%83%A9%E3%82%BA%E3%83%99%E3%83%AA%E3%83%BC%E3%83%91%E3%82%A4\"><i class=\"fa fa-link\"></i></a>RaspberryPi as ラズベリーパイ</h3>\n<p data-sourcepos=\"32:1-32:99\">定期実行はすべてラズベリーパイを使ってます。メルカリで買ったやつ。</p>\n<p data-sourcepos=\"34:1-34:99\">公開サーバーにするための記事も含めて、このあたりで色々書いてます。</p>\n<p data-sourcepos=\"36:1-36:52\"><iframe id=\"qiita-embed-content__eee22f6f5ad4682e75d7fa2796f10358\" src=\"https://qiita.com/embed-contents/link-card#qiita-embed-content__eee22f6f5ad4682e75d7fa2796f10358\" data-content=\"https%3A%2F%2Fqiita.com%2Fykhirao%2Fitems%2Ff26e18364594e7077612\" frameborder=\"0\" scrolling=\"no\" loading=\"lazy\" style=\"width:100%;\" height=\"29\">\n</iframe>\n</p>\n<p data-sourcepos=\"39:1-39:67\">以下のように <code>ssh pi</code> でログインして使ってます。</p>\n<div class=\"code-frame\" data-lang=\"terminal\" data-sourcepos=\"41:1-51:3\"><div class=\"highlight\"><pre><code><span class=\"gp\">$</span><span class=\"w\"> </span>ssh pi\n<span class=\"go\">\n</span><span class=\"gp\">$</span><span class=\"w\"> </span>~/.ssh/config\n<span class=\"go\">Host pi\n  HostName raspberrypi.local\n  User __yourname__\n  IdentityFile /Users/__yourname__/.ssh/id_rsa_pi\n</span><span class=\"gp\">  RemoteCommand cd /home/__yourname__/workspace/piapp;</span><span class=\"w\"> </span><span class=\"nv\">$SHELL</span> <span class=\"nt\">-il</span>\n<span class=\"go\">  RequestTTY yes\n</span></code></pre></div></div>\n<p data-sourcepos=\"53:1-53:293\">VSCodeもRemote SSHのプラグインがあれば <code>&gt; Remote-ssh: Connect to Host</code> でpiを選択するとそのまま開発できます。ローカルよりも動作がもっさりなので私はMacOS側で開発して GitHub経由の <code>git push</code> <code>git pull</code> を使って開発してました。</p>\n<h3 data-sourcepos=\"55:1-55:31\">\n<span id=\"nodejs-as-nodejsnodecron\" class=\"fragment\"></span><a href=\"#nodejs-as-nodejsnodecron\"><i class=\"fa fa-link\"></i></a>NodeJS as Node.js(NodeCron)</h3>\n<p data-sourcepos=\"57:1-57:9\">雰囲気</p>\n<div class=\"code-frame\" data-lang=\"terminal\" data-sourcepos=\"59:1-63:3\"><div class=\"highlight\"><pre><code><span class=\"gp\">$</span><span class=\"w\"> </span>brew <span class=\"nb\">install </span>n\n<span class=\"gp\">$</span><span class=\"w\"> </span>n auto\n<span class=\"gp\">$</span><span class=\"w\"> </span>npm i\n</code></pre></div></div>\n<h3 data-sourcepos=\"65:1-65:32\">\n<span id=\"planetscale-as-planetscaledb\" class=\"fragment\"></span><a href=\"#planetscale-as-planetscaledb\"><i class=\"fa fa-link\"></i></a>PlanetScale as PlanetScaleDB</h3>\n<p data-sourcepos=\"67:1-67:132\">言わずとしれたオンラインDBで、2021年11月に総額1億500万ドル（約150億円）を調達しているみたい。</p>\n<p data-sourcepos=\"69:1-69:6\">参考</p>\n<p data-sourcepos=\"71:1-71:51\"><iframe id=\"qiita-embed-content__27d52a480add8613c6fdc5e77506286c\" src=\"https://qiita.com/embed-contents/link-card#qiita-embed-content__27d52a480add8613c6fdc5e77506286c\" data-content=\"https%3A%2F%2Fqiita.com%2Ftak001%2Fitems%2Fcfbaa9dcb542929ff235\" frameborder=\"0\" scrolling=\"no\" loading=\"lazy\" style=\"width:100%;\" height=\"29\">\n</iframe>\n</p>\n<p data-sourcepos=\"73:1-73:272\">ラズベリーパイを公開サーバーにしていないので、ラズベリーパイにsshしないとデータが見えないよりも、オンラインサービスとして自分だけにでも公開したりするためにオンラインDBを利用してます。</p>\n<p data-sourcepos=\"75:1-75:58\">PCからのアクセスは Sequel Aceを使ってます。</p>\n<p data-sourcepos=\"77:1-77:23\"><iframe id=\"qiita-embed-content__32dfdcc7884f7deb38ba49879876e9fe\" src=\"https://qiita.com/embed-contents/link-card#qiita-embed-content__32dfdcc7884f7deb38ba49879876e9fe\" data-content=\"https%3A%2F%2Fsequel-ace.com%2F\" frameborder=\"0\" scrolling=\"no\" loading=\"lazy\" style=\"width:100%;\" height=\"29\">\n</iframe>\n</p>\n<p data-sourcepos=\"79:1-79:102\">接続情報を入力したら簡単にアクセスできてクエリも叩けるのでおすすめ。</p>\n<p data-sourcepos=\"81:1-81:163\"><a href=\"https://camo.qiitausercontent.com/6a2bb55cb6f451488e5cfd219985f295232f94c2/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3131323932392f64313937353931652d623862622d613139662d333663342d6665323466356462386437362e706e67\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F112929%2Fd197591e-b8bb-a19f-36c4-fe24f5db8d76.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=6882f71efadf7dbefeba515f5f75f12e\" alt=\"スクリーンショット 2023-12-25 15.08.47.png\" data-canonical-src=\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/d197591e-b8bb-a19f-36c4-fe24f5db8d76.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F112929%2Fd197591e-b8bb-a19f-36c4-fe24f5db8d76.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=86f2dfa1644cd857eda47ddb5cbfd2e0 1x\" loading=\"lazy\"></a></p>\n<p data-sourcepos=\"83:1-84:166\">PlanetScaleでRead権限のみのユーザーを発行して普段はそれを使えますね。<br>\n書き込むときだけWrite権限ユーザー使しましょう。（私は面倒なので基本Write権限ユーザーでクエリ叩いてます。。。。。）</p>\n<h3 data-sourcepos=\"86:1-86:32\">\n<span id=\"playwritenodejs-as-playwrite\" class=\"fragment\"></span><a href=\"#playwritenodejs-as-playwrite\"><i class=\"fa fa-link\"></i></a>PlayWriteNodeJS as PlayWrite</h3>\n<p data-sourcepos=\"88:1-88:57\">ここで雰囲気のコードを公開しています。</p>\n<p data-sourcepos=\"90:1-90:52\"><iframe id=\"qiita-embed-content__96d1de5ac064503680c1bcbe0a5895ea\" src=\"https://qiita.com/embed-contents/link-card#qiita-embed-content__96d1de5ac064503680c1bcbe0a5895ea\" data-content=\"https%3A%2F%2Fqiita.com%2Fykhirao%2Fitems%2F9b564e65d9c0a19bf2e0\" frameborder=\"0\" scrolling=\"no\" loading=\"lazy\" style=\"width:100%;\" height=\"29\">\n</iframe>\n</p>\n<p data-sourcepos=\"92:1-93:93\">画像のスクリーンショットも取れるので必要があれば使えます。<br>\nもちろん生DOMを解析してそれだけを返せるならそれが一番軽いです。</p>\n<p data-sourcepos=\"95:1-96:126\">zipのダウンロードはこれくらいの記述でいけます。<br>\nロケーターが表示されるまで待機するコードとか必要ないのでかなり楽にコードが書けます。</p>\n<div class=\"code-frame\" data-lang=\"ts\" data-sourcepos=\"98:1-106:3\"><div class=\"highlight\"><pre><code><span class=\"k\">await</span> <span class=\"nx\">page</span><span class=\"p\">.</span><span class=\"nf\">goto</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">URL</span><span class=\"dl\">'</span><span class=\"p\">);</span>\n<span class=\"k\">await</span> <span class=\"nx\">page</span><span class=\"p\">.</span><span class=\"nf\">locator</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">input[name=password]</span><span class=\"dl\">'</span><span class=\"p\">).</span><span class=\"nf\">fill</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">password</span><span class=\"dl\">'</span><span class=\"p\">));</span>\n<span class=\"k\">await</span> <span class=\"nx\">page</span><span class=\"p\">.</span><span class=\"nf\">locator</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">input[type=submit]</span><span class=\"dl\">'</span><span class=\"p\">).</span><span class=\"nf\">click</span><span class=\"p\">({</span> <span class=\"na\">timeout</span><span class=\"p\">:</span> <span class=\"mi\">120</span> <span class=\"o\">*</span> <span class=\"mi\">1000</span> <span class=\"p\">})</span>\n<span class=\"k\">await</span> <span class=\"nx\">page</span><span class=\"p\">.</span><span class=\"nf\">locator</span><span class=\"p\">(</span><span class=\"dl\">\"</span><span class=\"s2\">a[title$='.zip']</span><span class=\"dl\">\"</span><span class=\"p\">).</span><span class=\"nf\">click</span><span class=\"p\">({</span> <span class=\"na\">timeout</span><span class=\"p\">:</span> <span class=\"mi\">120</span> <span class=\"o\">*</span> <span class=\"mi\">1000</span> <span class=\"p\">});</span>\n<span class=\"kd\">const</span> <span class=\"nx\">download</span> <span class=\"o\">=</span> <span class=\"k\">await</span> <span class=\"nx\">downloadPromise</span><span class=\"p\">;</span>\n<span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nf\">log</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">file name: </span><span class=\"dl\">'</span><span class=\"p\">,</span> <span class=\"nx\">download</span><span class=\"p\">.</span><span class=\"nf\">suggestedFilename</span><span class=\"p\">());</span>\n<span class=\"k\">await</span> <span class=\"nx\">download</span><span class=\"p\">.</span><span class=\"nf\">saveAs</span><span class=\"p\">(</span><span class=\"s2\">`</span><span class=\"p\">${</span><span class=\"nx\">downloadsPath</span><span class=\"p\">}</span><span class=\"s2\">/</span><span class=\"p\">${</span><span class=\"nx\">download</span><span class=\"p\">.</span><span class=\"nf\">suggestedFilename</span><span class=\"p\">()}</span><span class=\"s2\">`</span><span class=\"p\">);</span>\n</code></pre></div></div>\n<p data-sourcepos=\"108:1-108:164\">ラズベリーパイが非力で表示するのに30秒以上かかるケースが多いのでタイムアウトを2分にしてます。 <code>{ timeout: 120 * 1000 }</code></p>\n<h3 data-sourcepos=\"110:1-110:31\">\n<span id=\"tesseractjs-as-tesseractjs\" class=\"fragment\"></span><a href=\"#tesseractjs-as-tesseractjs\"><i class=\"fa fa-link\"></i></a>TesseractJS as Tesseract.js</h3>\n<p data-sourcepos=\"112:1-112:51\">OCRはこのあたりを参考に書きました。</p>\n<p data-sourcepos=\"114:1-114:56\"><iframe id=\"qiita-embed-content__264ac89f498476b95dcb387e83eb0f1c\" src=\"https://qiita.com/embed-contents/link-card#qiita-embed-content__264ac89f498476b95dcb387e83eb0f1c\" data-content=\"https%3A%2F%2Fqiita.com%2Fyamayamasan%2Fitems%2F1dd911b817c8bb51fc43\" frameborder=\"0\" scrolling=\"no\" loading=\"lazy\" style=\"width:100%;\" height=\"29\">\n</iframe>\n</p>\n<p data-sourcepos=\"116:1-116:80\">512MBのラズパイでもそれなりに動くので一旦満足してます。</p>\n<p data-sourcepos=\"118:1-118:82\">こんな感じで動きます。ファイルへのpathがあれば動きます。</p>\n<div class=\"code-frame\" data-lang=\"ts\" data-sourcepos=\"120:1-128:3\"><div class=\"highlight\"><pre><code><span class=\"kd\">const</span> <span class=\"nx\">worker</span> <span class=\"o\">=</span> <span class=\"k\">await</span> <span class=\"nf\">createWorker</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">jpn</span><span class=\"dl\">'</span><span class=\"p\">);</span>\n\n<span class=\"k\">for </span><span class=\"p\">(</span><span class=\"kd\">const</span> <span class=\"nx\">p</span> <span class=\"k\">of</span> <span class=\"nx\">paths</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nf\">log</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">Fired OCR: </span><span class=\"dl\">'</span><span class=\"p\">,</span> <span class=\"nx\">p</span><span class=\"p\">);</span>\n    <span class=\"kd\">const</span> <span class=\"p\">{</span> <span class=\"na\">data</span><span class=\"p\">:</span> <span class=\"p\">{</span> <span class=\"nx\">text</span> <span class=\"p\">}</span> <span class=\"p\">}</span> <span class=\"o\">=</span> <span class=\"k\">await</span> <span class=\"nx\">worker</span><span class=\"p\">.</span><span class=\"nf\">recognize</span><span class=\"p\">(</span><span class=\"nx\">p</span><span class=\"p\">);</span>\n    <span class=\"nx\">values</span><span class=\"p\">.</span><span class=\"nf\">push</span><span class=\"p\">(</span><span class=\"s2\">`### </span><span class=\"p\">${</span><span class=\"nx\">today</span><span class=\"p\">}</span><span class=\"s2\">\\n\\n</span><span class=\"p\">${</span><span class=\"nx\">text</span><span class=\"p\">}</span><span class=\"s2\">`</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n</code></pre></div></div>\n<p data-sourcepos=\"130:1-130:93\">ただ結果は空白入りとかで返ってくるのでどうにかして整形したい。</p>\n<div class=\"code-frame\" data-lang=\"text\" data-sourcepos=\"132:1-136:3\"><div class=\"highlight\"><pre><code>こんな感じで動きます。ファイルへのpathがあれば動きます。\n↓\nこ　ん　な感　じで　　動　きます。ファ　イ　ル　　へのp　ath　があ　　れ　ば　動きま　す。\n</code></pre></div></div>\n<p data-sourcepos=\"138:1-138:131\">たぶんTextLintとかでいけると思ってますが、イマイチ設定がわからないので一旦あきらめてます。</p>\n<h3 data-sourcepos=\"140:1-140:24\">\n<span id=\"qiitaapi-as-qiitaapi\" class=\"fragment\"></span><a href=\"#qiitaapi-as-qiitaapi\"><i class=\"fa fa-link\"></i></a>QiitaAPI as QiitaAPI</h3>\n<p data-sourcepos=\"142:1-142:111\">Privateのブログを作成し、QiitaのAPIを使って取得するたびに追記をしていってます。</p>\n<p data-sourcepos=\"144:1-144:226\">次のNtfySHの通知が本文5kbくらいの制限があり attachment.txt みたいな形式で送られてきてしまうので、本文そのままの添付を諦めて一旦QiitaのPrivateブログに追記してます。</p>\n<p data-sourcepos=\"147:1-147:54\">こんな感じで取得と編集をしています。</p>\n<div class=\"code-frame\" data-lang=\"js\" data-sourcepos=\"149:1-159:3\"><div class=\"highlight\"><pre><code><span class=\"kd\">const</span> <span class=\"nx\">res</span> <span class=\"o\">=</span> <span class=\"k\">await</span> <span class=\"nf\">fetch</span><span class=\"p\">(</span><span class=\"s2\">`https://qiita.com/api/v2/items/</span><span class=\"p\">${</span><span class=\"nx\">id</span><span class=\"p\">}</span><span class=\"s2\">`</span><span class=\"p\">,</span> <span class=\"nx\">PUBLIC_OPTIONS</span><span class=\"p\">);</span>\n<span class=\"kd\">const</span> <span class=\"nx\">res</span> <span class=\"o\">=</span> <span class=\"k\">await</span> <span class=\"nf\">fetch</span><span class=\"p\">(</span><span class=\"s2\">`https://qiita.com/api/v2/items/</span><span class=\"p\">${</span><span class=\"nx\">id</span><span class=\"p\">}</span><span class=\"s2\">`</span><span class=\"p\">,</span> <span class=\"p\">{</span>\n    <span class=\"p\">...</span><span class=\"nx\">AUTH_OPTIONS</span><span class=\"p\">,</span>\n    <span class=\"na\">method</span><span class=\"p\">:</span> <span class=\"dl\">'</span><span class=\"s1\">PATCH</span><span class=\"dl\">'</span><span class=\"p\">,</span>\n    <span class=\"na\">body</span><span class=\"p\">:</span> <span class=\"nx\">JSON</span><span class=\"p\">.</span><span class=\"nf\">stringify</span><span class=\"p\">({</span>\n        <span class=\"na\">body</span><span class=\"p\">:</span> <span class=\"nx\">bodyString</span><span class=\"p\">,</span>\n        <span class=\"nx\">title</span><span class=\"p\">,</span>\n    <span class=\"p\">})</span>\n<span class=\"p\">});</span>\n</code></pre></div></div>\n<p data-sourcepos=\"161:1-161:196\">編集時に <code>body</code> だけが必須かと思ってずっと失敗してましたが <code>title</code> も必須でした。ドキュメントのしたの方に書かないでほしかった。。。。<img alt=\":bow:\" class=\"emoji\" height=\"20\" src=\"https://cdn.qiita.com/emoji/twemoji/unicode/1f647.png\" title=\":bow:\" width=\"20\" loading=\"lazy\"></p>\n<h3 data-sourcepos=\"163:1-163:21\">\n<span id=\"ntfysh-as-ntfysh\" class=\"fragment\"></span><a href=\"#ntfysh-as-ntfysh\"><i class=\"fa fa-link\"></i></a>NtfySH as ntfy.sh</h3>\n<p data-sourcepos=\"165:1-165:117\">自分用LineDeveloperアカウントや自分用Slackで通知してた方は一度試してみてほしいです。</p>\n<p data-sourcepos=\"167:1-167:89\">15.1Kのスターを集めているOSSで、自社でもホスティングできます。</p>\n<p data-sourcepos=\"169:1-169:37\"><iframe id=\"qiita-embed-content__ad680e384baaac9e7d961bb4a7828ab0\" src=\"https://qiita.com/embed-contents/link-card#qiita-embed-content__ad680e384baaac9e7d961bb4a7828ab0\" data-content=\"https%3A%2F%2Fgithub.com%2Fbinwiederhier%2Fntfy\" frameborder=\"0\" scrolling=\"no\" loading=\"lazy\" style=\"width:100%;\" height=\"29\">\n</iframe>\n</p>\n<p data-sourcepos=\"171:1-171:184\">投稿回数の制限等はあるものの <a href=\"https://ntfy.sh/\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\">https://ntfy.sh/</a> でも十分通知可能（1日250回ほど通知できる）なので一旦無料プランで試してみてください。</p>\n<p data-sourcepos=\"173:1-173:66\">これだけで通知ができるのは簡単すぎませんか？</p>\n<div class=\"code-frame\" data-lang=\"js\" data-sourcepos=\"175:1-180:3\"><div class=\"highlight\"><pre><code><span class=\"nf\">fetch</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">https://ntfy.sh/mytopic</span><span class=\"dl\">'</span><span class=\"p\">,</span> <span class=\"p\">{</span>\n    <span class=\"na\">method</span><span class=\"p\">:</span> <span class=\"dl\">'</span><span class=\"s1\">POST</span><span class=\"dl\">'</span><span class=\"p\">,</span> <span class=\"c1\">// PUT works too</span>\n    <span class=\"na\">body</span><span class=\"p\">:</span> <span class=\"dl\">'</span><span class=\"s1\">Backup successful 😀</span><span class=\"dl\">'</span>\n<span class=\"p\">})</span>\n</code></pre></div></div>\n<h3 data-sourcepos=\"183:1-183:27\">\n<span id=\"smartphone-as-スマホ\" class=\"fragment\"></span><a href=\"#smartphone-as-%E3%82%B9%E3%83%9E%E3%83%9B\"><i class=\"fa fa-link\"></i></a>Smartphone as スマホ</h3>\n<p data-sourcepos=\"185:1-185:75\">NtfySHのアプリが必要ですが簡単に通知が飛んできます。</p>\n<p data-sourcepos=\"187:1-187:134\"><a href=\"https://ntfy.sh/\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\">https://ntfy.sh/</a> をChromeで入り、サイトの通知を許可するとアプリなしでもchrome経由の通知が可能のはず</p>\n<h2 data-sourcepos=\"190:1-190:12\">\n<span id=\"最後に\" class=\"fragment\"></span><a href=\"#%E6%9C%80%E5%BE%8C%E3%81%AB\"><i class=\"fa fa-link\"></i></a>最後に</h2>\n<p data-sourcepos=\"192:1-193:118\">今回自分用のサービスを公開してアーキテクチャ図？を作ってみました。<br>\n正直mermaidが使いたかっただけですが、誰かの参考になればと思い供養投稿になります。</p>\n<h2 data-sourcepos=\"196:1-196:27\">\n<span id=\"できなかったこと\" class=\"fragment\"></span><a href=\"#%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%8B%E3%81%A3%E3%81%9F%E3%81%93%E3%81%A8\"><i class=\"fa fa-link\"></i></a>できなかったこと</h2>\n<p data-sourcepos=\"198:1-198:458\">MacOS上で <code>PlanetScale + Prisma</code> を使い開発していて、いざバッチ処理開始するときにPrismaをラズベリーパイにいれられないことが判明した。以下記事が参考になったが、そもそも私のメルカリで買った安めの非力ラズベリーパイだとビルド時間かかりすぎて終わりそうになかったので一旦あきらめてmysql2でアクセスしてます。SQL直書きしてます。</p>\n<p data-sourcepos=\"200:1-200:45\"><iframe id=\"qiita-embed-content__334fd6543d84236576f725e4b6563254\" src=\"https://qiita.com/embed-contents/link-card#qiita-embed-content__334fd6543d84236576f725e4b6563254\" data-content=\"https%3A%2F%2Fzenn.dev%2Fbowz%2Farticles%2F03c551269218aa\" frameborder=\"0\" scrolling=\"no\" loading=\"lazy\" style=\"width:100%;\" height=\"29\">\n</iframe>\n</p>\n<h3 data-sourcepos=\"202:1-202:10\">\n<span id=\"mysql2\" class=\"fragment\"></span><a href=\"#mysql2\"><i class=\"fa fa-link\"></i></a>mysql2</h3>\n<p data-sourcepos=\"204:1-205:382\">こういうサービスのconnectionを切るのってどうすればいいのかわからない。<br>\n繋ぎっぱなしでいいの？切ったら切ったらで繋げないし、コネクトが二個あるときはエラーで落ちるし、ってことで <code>await connection.connect().catch(_ =&gt; console.log('Already connected'));</code> バッチ処理最終にコネクトを切って、毎度コネクトをキャッチして使うことにした。あっているかわからない。</p>\n<div class=\"code-frame\" data-lang=\"ts\" data-sourcepos=\"207:1-221:3\"><div class=\"highlight\"><pre><code><span class=\"k\">export</span> <span class=\"kd\">const</span> <span class=\"nx\">runQuery</span> <span class=\"o\">=</span> <span class=\"k\">async</span> <span class=\"o\">&lt;</span><span class=\"nx\">T</span> <span class=\"o\">=</span> <span class=\"kr\">any</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"nx\">query</span><span class=\"p\">:</span> <span class=\"kr\">string</span><span class=\"p\">,</span> <span class=\"nx\">options</span><span class=\"p\">:</span> <span class=\"kr\">any</span><span class=\"p\">[]):</span> <span class=\"nb\">Promise</span><span class=\"o\">&lt;</span><span class=\"nx\">T</span><span class=\"p\">[]</span><span class=\"o\">&gt;</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"k\">if </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"nx\">connection</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">if </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"nx\">process</span><span class=\"p\">.</span><span class=\"nx\">env</span><span class=\"p\">.</span><span class=\"nx\">DATABASE_URL</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n      <span class=\"kd\">const</span> <span class=\"nx\">msg</span> <span class=\"o\">=</span> <span class=\"dl\">'</span><span class=\"s1\">DATABASE_URL is not defined</span><span class=\"dl\">'</span><span class=\"p\">;</span>\n      <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nf\">error</span><span class=\"p\">(</span><span class=\"nx\">msg</span><span class=\"p\">);</span>\n      <span class=\"k\">throw</span> <span class=\"k\">new</span> <span class=\"nc\">Error</span><span class=\"p\">(</span><span class=\"nx\">msg</span><span class=\"p\">);</span>\n    <span class=\"p\">}</span>\n    <span class=\"nx\">connection</span> <span class=\"o\">=</span> <span class=\"k\">await</span> <span class=\"nf\">createConnection</span><span class=\"p\">(</span><span class=\"nx\">process</span><span class=\"p\">.</span><span class=\"nx\">env</span><span class=\"p\">.</span><span class=\"nx\">DATABASE_URL</span><span class=\"p\">);</span>\n  <span class=\"p\">}</span>\n  <span class=\"k\">await</span> <span class=\"nx\">connection</span><span class=\"p\">.</span><span class=\"nf\">connect</span><span class=\"p\">().</span><span class=\"k\">catch</span><span class=\"p\">(</span><span class=\"nx\">_</span> <span class=\"o\">=&gt;</span> <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nf\">log</span><span class=\"p\">(</span><span class=\"dl\">'</span><span class=\"s1\">Already connected</span><span class=\"dl\">'</span><span class=\"p\">));</span>\n  <span class=\"kd\">const</span> <span class=\"p\">[</span><span class=\"nx\">rows</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"k\">await</span> <span class=\"nx\">connection</span><span class=\"p\">.</span><span class=\"nf\">query</span><span class=\"p\">(</span><span class=\"nx\">query</span><span class=\"p\">,</span> <span class=\"nx\">options</span><span class=\"p\">)</span>\n  <span class=\"k\">return</span> <span class=\"nx\">rows</span> <span class=\"k\">as</span> <span class=\"nx\">T</span><span class=\"p\">[];</span>\n<span class=\"p\">}</span>\n</code></pre></div></div>\n","body":"\n## Mermaid\n\n```mermaid\nsequenceDiagram\n    participant RaspberryPi as ラズベリーパイ\n    participant NodeJS as Node.js(NodeCron)\n    participant PlanetScaleDB as PlanetScaleDB\n    participant PlayWriteNodeJS as PlayWrite\n    participant TesseractJS as Tesseract.js\n    participant QiitaAPI as QiitaAPI\n    participant NtfySH as ntfy.sh\n    participant Smartphone as スマホ\n\n    RaspberryPi ->> NodeJS: Foreverでデーモン化\n    NodeJS ->> PlanetScaleDB: 各種データはオンライン保存\n    PlanetScaleDB -->> NodeJS: DB確認して処理済みなら再実行\n    NodeJS ->> PlayWriteNodeJS: 画像を取得\n    PlayWriteNodeJS -->> NodeJS: 画像をダウンロード\n    NodeJS ->> TesseractJS: 画像をOCR解析\n    TesseractJS -->> NodeJS: 解析結果\n    NodeJS ->> QiitaAPI: ブログに投稿\n    QiitaAPI -->> NodeJS: URLを取得\n    NodeJS ->> NtfySH: スマホにブログURLを通知\n    NtfySH ->> Smartphone: 通知\n```\n\n## 簡単な解説\n\n### RaspberryPi as ラズベリーパイ\n\n定期実行はすべてラズベリーパイを使ってます。メルカリで買ったやつ。\n\n公開サーバーにするための記事も含めて、このあたりで色々書いてます。\n\nhttps://qiita.com/ykhirao/items/f26e18364594e7077612\n\n\n以下のように `ssh pi` でログインして使ってます。\n\n```terminal\n$ ssh pi\n\n$ ~/.ssh/config\nHost pi\n  HostName raspberrypi.local\n  User __yourname__\n  IdentityFile /Users/__yourname__/.ssh/id_rsa_pi\n  RemoteCommand cd /home/__yourname__/workspace/piapp; $SHELL -il\n  RequestTTY yes\n```\n\nVSCodeもRemote SSHのプラグインがあれば `> Remote-ssh: Connect to Host` でpiを選択するとそのまま開発できます。ローカルよりも動作がもっさりなので私はMacOS側で開発して GitHub経由の `git push` `git pull` を使って開発してました。\n\n### NodeJS as Node.js(NodeCron)\n\n雰囲気\n\n```terminal\n$ brew install n\n$ n auto\n$ npm i\n```\n\n### PlanetScale as PlanetScaleDB\n\n言わずとしれたオンラインDBで、2021年11月に総額1億500万ドル（約150億円）を調達しているみたい。\n\n参考\n\nhttps://qiita.com/tak001/items/cfbaa9dcb542929ff235\n\nラズベリーパイを公開サーバーにしていないので、ラズベリーパイにsshしないとデータが見えないよりも、オンラインサービスとして自分だけにでも公開したりするためにオンラインDBを利用してます。\n\nPCからのアクセスは Sequel Aceを使ってます。\n\nhttps://sequel-ace.com/\n\n接続情報を入力したら簡単にアクセスできてクエリも叩けるのでおすすめ。\n\n![スクリーンショット 2023-12-25 15.08.47.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/d197591e-b8bb-a19f-36c4-fe24f5db8d76.png)\n\nPlanetScaleでRead権限のみのユーザーを発行して普段はそれを使えますね。\n書き込むときだけWrite権限ユーザー使しましょう。（私は面倒なので基本Write権限ユーザーでクエリ叩いてます。。。。。）\n\n### PlayWriteNodeJS as PlayWrite\n\nここで雰囲気のコードを公開しています。\n\nhttps://qiita.com/ykhirao/items/9b564e65d9c0a19bf2e0\n\n画像のスクリーンショットも取れるので必要があれば使えます。\nもちろん生DOMを解析してそれだけを返せるならそれが一番軽いです。\n\nzipのダウンロードはこれくらいの記述でいけます。\nロケーターが表示されるまで待機するコードとか必要ないのでかなり楽にコードが書けます。\n\n```ts\nawait page.goto('URL');\nawait page.locator('input[name=password]').fill('password'));\nawait page.locator('input[type=submit]').click({ timeout: 120 * 1000 })\nawait page.locator(\"a[title$='.zip']\").click({ timeout: 120 * 1000 });\nconst download = await downloadPromise;\nconsole.log('file name: ', download.suggestedFilename());\nawait download.saveAs(`${downloadsPath}/${download.suggestedFilename()}`);\n```\n\nラズベリーパイが非力で表示するのに30秒以上かかるケースが多いのでタイムアウトを2分にしてます。 `{ timeout: 120 * 1000 }`\n\n### TesseractJS as Tesseract.js\n\nOCRはこのあたりを参考に書きました。\n\nhttps://qiita.com/yamayamasan/items/1dd911b817c8bb51fc43\n\n512MBのラズパイでもそれなりに動くので一旦満足してます。\n\nこんな感じで動きます。ファイルへのpathがあれば動きます。\n\n```ts\nconst worker = await createWorker('jpn');\n\nfor (const p of paths) {\n    console.log('Fired OCR: ', p);\n    const { data: { text } } = await worker.recognize(p);\n    values.push(`### ${today}\\n\\n${text}`);\n}\n```\n\nただ結果は空白入りとかで返ってくるのでどうにかして整形したい。\n\n```text\nこんな感じで動きます。ファイルへのpathがあれば動きます。\n↓\nこ　ん　な感　じで　　動　きます。ファ　イ　ル　　へのp　ath　があ　　れ　ば　動きま　す。\n```\n\nたぶんTextLintとかでいけると思ってますが、イマイチ設定がわからないので一旦あきらめてます。\n\n### QiitaAPI as QiitaAPI\n\nPrivateのブログを作成し、QiitaのAPIを使って取得するたびに追記をしていってます。\n\n次のNtfySHの通知が本文5kbくらいの制限があり attachment.txt みたいな形式で送られてきてしまうので、本文そのままの添付を諦めて一旦QiitaのPrivateブログに追記してます。\n\n\nこんな感じで取得と編集をしています。\n\n```js\nconst res = await fetch(`https://qiita.com/api/v2/items/${id}`, PUBLIC_OPTIONS);\nconst res = await fetch(`https://qiita.com/api/v2/items/${id}`, {\n    ...AUTH_OPTIONS,\n    method: 'PATCH',\n    body: JSON.stringify({\n        body: bodyString,\n        title,\n    })\n});\n```\n\n編集時に `body` だけが必須かと思ってずっと失敗してましたが `title` も必須でした。ドキュメントのしたの方に書かないでほしかった。。。。:bow:\n\n### NtfySH as ntfy.sh\n\n自分用LineDeveloperアカウントや自分用Slackで通知してた方は一度試してみてほしいです。\n\n15.1Kのスターを集めているOSSで、自社でもホスティングできます。\n\nhttps://github.com/binwiederhier/ntfy\n\n投稿回数の制限等はあるものの https://ntfy.sh/ でも十分通知可能（1日250回ほど通知できる）なので一旦無料プランで試してみてください。\n\nこれだけで通知ができるのは簡単すぎませんか？\n\n```js\nfetch('https://ntfy.sh/mytopic', {\n    method: 'POST', // PUT works too\n    body: 'Backup successful 😀'\n})\n```\n\n\n### Smartphone as スマホ\n\nNtfySHのアプリが必要ですが簡単に通知が飛んできます。\n\nhttps://ntfy.sh/ をChromeで入り、サイトの通知を許可するとアプリなしでもchrome経由の通知が可能のはず\n\n\n## 最後に\n\n今回自分用のサービスを公開してアーキテクチャ図？を作ってみました。\n正直mermaidが使いたかっただけですが、誰かの参考になればと思い供養投稿になります。\n\n\n## できなかったこと\n\nMacOS上で `PlanetScale + Prisma` を使い開発していて、いざバッチ処理開始するときにPrismaをラズベリーパイにいれられないことが判明した。以下記事が参考になったが、そもそも私のメルカリで買った安めの非力ラズベリーパイだとビルド時間かかりすぎて終わりそうになかったので一旦あきらめてmysql2でアクセスしてます。SQL直書きしてます。\n\nhttps://zenn.dev/bowz/articles/03c551269218aa\n\n### mysql2\n\nこういうサービスのconnectionを切るのってどうすればいいのかわからない。\n繋ぎっぱなしでいいの？切ったら切ったらで繋げないし、コネクトが二個あるときはエラーで落ちるし、ってことで `await connection.connect().catch(_ => console.log('Already connected'));` バッチ処理最終にコネクトを切って、毎度コネクトをキャッチして使うことにした。あっているかわからない。\n\n```ts\nexport const runQuery = async <T = any>(query: string, options: any[]): Promise<T[]> => {\n  if (!connection) {\n    if (!process.env.DATABASE_URL) {\n      const msg = 'DATABASE_URL is not defined';\n      console.error(msg);\n      throw new Error(msg);\n    }\n    connection = await createConnection(process.env.DATABASE_URL);\n  }\n  await connection.connect().catch(_ => console.log('Already connected'));\n  const [rows] = await connection.query(query, options)\n  return rows as T[];\n}\n```\n\n","coediting":false,"comments_count":0,"created_at":"2023-12-25T14:53:51+09:00","group":null,"id":"558973f35eccecdf4cfe","likes_count":2,"private":false,"reactions_count":0,"stocks_count":1,"tags":[{"name":"JavaScript","versions":[]},{"name":"TypeScript","versions":[]},{"name":"OCR","versions":[]}],"title":"毎日画像をOCRしてスマホに通知するサービスを作ったので簡単なアーキテクチャを紹介","updated_at":"2023-12-25T15:11:38+09:00","url":"https://qiita.com/ykhirao/items/558973f35eccecdf4cfe","user":{"description":"Web Developer From 2016.\r\nPHP/Laravel && React/TypeScript/Node.js\r\n\r\n業務委託の依頼とかはWantedlyとかからでお願いします！","facebook_id":"","followees_count":39,"followers_count":100,"github_login_name":"ykhirao","id":"ykhirao","items_count":83,"linkedin_id":"","location":"Tokyo, Japan","name":"yk","organization":"","permanent_id":112929,"profile_image_url":"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/profile-images/1639030792","team_only":false,"twitter_screen_name":"ykhirao","website_url":"https://www.wantedly.com/id/ykhirao"},"page_views_count":null,"team_membership":null,"organization_url_name":"admin-guild","slide":false}},"path":"posts/558973f35eccecdf4cfe"}
