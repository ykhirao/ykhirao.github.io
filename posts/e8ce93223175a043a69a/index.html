<!DOCTYPE html><html lang="en"><head><meta name="generator" content="React Static"/><meta charSet="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, shrink-to-fit=no"/><link rel="preload" as="script" href="/templates/styles.60fb0704.js"/><link rel="preload" as="script" href="/templates/vendors~main.991a9778.js"/><link rel="preload" as="script" href="/main.e4c894d8.js"/><link rel="preload" as="style" href="/styles.642cfcb4.css"/><link rel="stylesheet" href="/styles.642cfcb4.css"/><link rel="shortcut icon" href="/favicon.ico"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png"/><link rel="manifest" href="/manifest.json"/><meta name="mobile-web-app-capable" content="yes"/><meta name="theme-color" content="#fff"/><meta name="application-name"/><link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png"/><link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png"/><link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png"/><link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png"/><link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png"/><link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png"/><link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png"/><link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png"/><link rel="apple-touch-icon" sizes="167x167" href="/apple-touch-icon-167x167.png"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png"/><link rel="apple-touch-icon" sizes="1024x1024" href="/apple-touch-icon-1024x1024.png"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/><meta name="apple-mobile-web-app-title"/><link rel="apple-touch-startup-image" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-640x1136.png"/><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-750x1334.png"/><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-828x1792.png"/><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1125x2436.png"/><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1242x2208.png"/><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/apple-touch-startup-image-1242x2688.png"/><link rel="apple-touch-startup-image" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1536x2048.png"/><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1668x2224.png"/><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1668x2388.png"/><link rel="apple-touch-startup-image" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-2048x2732.png"/><link rel="apple-touch-startup-image" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="/apple-touch-startup-image-1620x2160.png"/><link rel="apple-touch-startup-image" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1136x640.png"/><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1334x750.png"/><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-1792x828.png"/><link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2436x1125.png"/><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2208x1242.png"/><link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="/apple-touch-startup-image-2688x1242.png"/><link rel="apple-touch-startup-image" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2048x1536.png"/><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2224x1668.png"/><link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2388x1668.png"/><link rel="apple-touch-startup-image" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2732x2048.png"/><link rel="apple-touch-startup-image" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="/apple-touch-startup-image-2160x1620.png"/><link rel="icon" type="image/png" sizes="228x228" href="/coast-228x228.png"/><meta name="msapplication-TileColor" content="#fff"/><meta name="msapplication-TileImage" content="/mstile-144x144.png"/><meta name="msapplication-config" content="/browserconfig.xml"/><link rel="yandex-tableau-widget" href="/yandex-browser-manifest.json"/></head><body><div id="root"><div style="outline:none" tabindex="-1"><nav class="navbar is-dark is-fixed-top" role="navigation" aria-label="main navigation"><div class="container"><div class="navbar-brand"><a class="navbar-item" href="/">Home</a><a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false"><span aria-hidden="true"></span><span aria-hidden="true"></span><span aria-hidden="true"></span></a></div><div id="navbarBasicExample" class="navbar-menu "><div class="navbar-start"><a class="navbar-item" href="/posts">Posts</a><a class="navbar-item" href="/events">Events</a><a class="navbar-item" href="/github">GitHub</a></div></div></div></nav><div class="container"><div class="is-primary" style="padding:4.5rem 0.5rem"><div style="outline:none" tabindex="-1"><div><a href="/posts">&lt;<!-- --> Back</a><br/><h3>【GAS】Gmail APIを使わずにGmailをAPI経由で取得する</h3><article class="md-body"><p data-sourcepos="2:1-2:45">以下のような構成を取ればいい。</p>
<iframe id="qiita-embed-content__bdfc33a0b9010aa9f7d3972b6cc9dc83" src="https://qiita.com/embed-contents/mermaid#qiita-embed-content__bdfc33a0b9010aa9f7d3972b6cc9dc83" style="width:100%;" frameborder="0" scrolling="no" loading="lazy" data-content='{"data":"flowchart LR\nA[Gmail] -- 取得 --&gt; B[Google Apps Script]\nB -- API --&gt; C","key":"ab82bed4f054297ba71e803fa9d9d937"}'>
</iframe>

<h2 data-sourcepos="11:1-11:24">
<span id="gmail-apiの面倒さ" class="fragment"></span><a href="#gmail-api%E3%81%AE%E9%9D%A2%E5%80%92%E3%81%95"><i class="fa fa-link"></i></a>Gmail APIの面倒さ</h2>
<p data-sourcepos="13:1-13:86">Cloud Functionsを使ったとしても、Gmail内容はAPIとして取得できない</p>
<p data-sourcepos="15:1-15:20">CloudFunctionsから</p>
<ul data-sourcepos="17:1-20:0">
<li data-sourcepos="17:1-17:46">「API とサービス」 「認証情報」</li>
<li data-sourcepos="18:1-18:71">「認証情報を作成」「OAuth クライアント ID」の取得</li>
<li data-sourcepos="19:1-20:0">...ClientサイドでAuthのコード書き、トークンの取得してGmailのAPIを叩く</li>
</ul>
<p data-sourcepos="21:1-21:9">面倒。</p>
<h2 data-sourcepos="23:1-23:66">
<span id="gasをwebアプリケーションとして公開してapi公開" class="fragment"></span><a href="#gas%E3%82%92web%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%A8%E3%81%97%E3%81%A6%E5%85%AC%E9%96%8B%E3%81%97%E3%81%A6api%E5%85%AC%E9%96%8B"><i class="fa fa-link"></i></a>GasをWebアプリケーションとして公開してAPI公開</h2>
<div class="code-frame" data-lang="javascript" data-sourcepos="26:1-87:3"><div class="highlight"><pre><code><span class="kd">const</span> <span class="nx">FAIL</span> <span class="o">=</span> <span class="p">{</span> <span class="na">ok</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> <span class="na">code</span><span class="p">:</span> <span class="kc">null</span> <span class="p">};</span>

<span class="kd">const</span> <span class="nx">output</span> <span class="o">=</span> <span class="nx">ContentService</span><span class="p">.</span><span class="nf">createTextOutput</span><span class="p">();</span>
<span class="nx">output</span><span class="p">.</span><span class="nf">setMimeType</span><span class="p">(</span><span class="nx">ContentService</span><span class="p">.</span><span class="nx">MimeType</span><span class="p">.</span><span class="nx">JSON</span><span class="p">);</span>
<span class="nx">output</span><span class="p">.</span><span class="nf">setContent</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nf">stringify</span><span class="p">(</span><span class="nx">FAIL</span><span class="p">));</span>

<span class="cm">/**
 * 認証ラベルがついたGmailを取得します
 * queryの例: https://blog.synnex.co.jp/google/gmail-gas/
 */</span>
<span class="kd">function</span> <span class="nf">getGmail</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">date</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">2023-04-17T11:00:00.000Z</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 認証ラベルの付いた、アカウントIDが本文にはいっているメールを1件取得する</span>
  <span class="kd">const</span> <span class="nx">newestThread</span> <span class="o">=</span> <span class="nx">GmailApp</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">id</span><span class="p">}</span><span class="s2"> label:タイトルXXX`</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>

  <span class="c1">// スレッドが存在しない</span>
  <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">newestThread</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">Logger</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">スレッドが存在しません</span><span class="dl">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">output</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">let</span> <span class="nx">messages</span> <span class="o">=</span> <span class="nx">newestThread</span><span class="p">.</span><span class="nf">getMessages</span><span class="p">();</span>
  <span class="nx">Logger</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">`messages length: </span><span class="p">${</span><span class="nx">messages</span><span class="p">.</span><span class="nx">length</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
  <span class="nx">messages</span> <span class="o">=</span> <span class="nx">messages</span><span class="p">.</span><span class="nf">filter</span><span class="p">((</span><span class="nx">message</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">message</span><span class="p">.</span><span class="nf">getPlainBody</span><span class="p">().</span><span class="nf">includes</span><span class="p">(</span><span class="nx">id</span><span class="p">))</span>
  <span class="c1">// date(Instagramクリック日時)) &lt; メール（message）受信日時</span>
  <span class="nx">messages</span> <span class="o">=</span> <span class="nx">messages</span><span class="p">.</span><span class="nf">filter</span><span class="p">((</span><span class="nx">message</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="k">new</span> <span class="nc">Date</span><span class="p">(</span><span class="nx">date</span><span class="p">)).</span><span class="nf">getTime</span><span class="p">()</span> <span class="o">&lt;</span> <span class="nx">message</span><span class="p">.</span><span class="nf">getDate</span><span class="p">().</span><span class="nf">getTime</span><span class="p">());</span>
  <span class="nx">Logger</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">`messages length: </span><span class="p">${</span><span class="nx">messages</span><span class="p">.</span><span class="nx">length</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>

  <span class="kd">const</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

  <span class="c1">// 指定時間より前のメールは無視する</span>
  <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">Logger</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">期間内のメールが存在しません</span><span class="dl">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">output</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">const</span> <span class="nx">code</span> <span class="o">=</span> <span class="nf">getCode</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nf">getPlainBody</span><span class="p">());</span>
  <span class="nx">Logger</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span>

  <span class="nx">output</span><span class="p">.</span><span class="nf">setContent</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nf">stringify</span><span class="p">({</span> <span class="na">ok</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">code</span> <span class="p">}))</span>
  <span class="k">return</span> <span class="nx">output</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**
 * param:  {
 *   "id": "",
 *   "data": "2023-04-17T16:18:00.173Z",
 *   "pass": "ベアラートークンみたいなの"
 * }
 */</span>
<span class="kd">function</span> <span class="nf">doGet</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">Logger</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">parameter</span><span class="p">;</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">params</span><span class="p">?.</span><span class="nx">pass</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">ベアラートークンみたいなの</span><span class="dl">'</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">Logger</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">passが間違いです。</span><span class="dl">"</span><span class="p">);</span>
    <span class="nx">output</span><span class="p">.</span><span class="nf">setContent</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nf">stringify</span><span class="p">(</span><span class="nx">FAIL</span><span class="p">));</span>
    <span class="k">return</span> <span class="nx">output</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nf">getGmail</span><span class="p">(</span><span class="nx">params</span><span class="p">?.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">params</span><span class="p">?.</span><span class="nx">date</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
<p data-sourcepos="89:1-89:15">Clientサイド</p>
<div class="code-frame" data-lang="js" data-sourcepos="91:1-103:3"><div class="highlight"><pre><code><span class="err">　　</span><span class="kd">const</span> <span class="nx">deployId</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">GAS画面からデプロイしたときのID_デプロイするたびに変わる</span><span class="dl">'</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="o">&lt;</span><span class="p">{</span> <span class="na">ok</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">code</span><span class="p">:</span> <span class="nx">string</span> <span class="p">}</span><span class="o">&gt;</span><span class="p">(</span>
    <span class="s2">`https://script.google.com/macros/s/</span><span class="p">${</span><span class="nx">deployId</span><span class="p">}</span><span class="s2">/exec`</span><span class="p">,</span>
    <span class="p">{</span>
      <span class="na">params</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">pass</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ベアラートークンみたいなの</span><span class="dl">'</span><span class="p">,</span>
        <span class="nx">date</span><span class="p">,</span>
        <span class="nx">id</span><span class="p">,</span>
      <span class="p">},</span>
    <span class="p">}</span>
  <span class="p">);</span>
</code></pre></div></div>
<p data-sourcepos="105:1-105:238">ベアラートークンみたいなのは任意の文字列128文字とか適当にジェネレートしたものを使って、絶対に推測できないものにしてください。UUIDに合わせると英数字の３２桁です。</p>
<p data-sourcepos="107:1-107:164">UUIDが16進数で32桁ですが、特定させるにはどれくらいの時間がかかるかを示した計算を参考にするのがいいかと思います。</p>
<p data-sourcepos="109:1-109:54"><iframe id="qiita-embed-content__c93389a25d1f021fae5a1de310b3ff24" src="https://qiita.com/embed-contents/link-card#qiita-embed-content__c93389a25d1f021fae5a1de310b3ff24" data-content="https%3A%2F%2Fzenn.dev%2Fkiyocy24%2Farticles%2Fuuid-duplicate-time" frameborder="0" scrolling="no" loading="lazy" style="width:100%;" height="29">
</iframe>
</p>
<p data-sourcepos="111:1-111:36">デプロイ方法はこんな感じ</p>
<p data-sourcepos="113:1-113:69">上部のデプロイボタンからウェブアプリとして公開</p>
<p data-sourcepos="115:1-115:163"><a href="https://camo.qiitausercontent.com/e84bf0cff05cb785a7e7ac24fbffd2709b37cfdc/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3131323932392f37653834656137392d363632372d323064352d353431622d3566353439363834636463342e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F112929%2F7e84ea79-6627-20d5-541b-5f549684cdc4.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=359f49a8e47382453802bf68aa0d96b7" alt="スクリーンショット 2023-05-24 13.58.21.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/7e84ea79-6627-20d5-541b-5f549684cdc4.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F112929%2F7e84ea79-6627-20d5-541b-5f549684cdc4.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=1396d90090e650a88db1100c8ccde5f8 1x" loading="lazy"></a></p>
<p data-sourcepos="117:1-117:38">もろもろ認証でOKを押したら</p>
<p data-sourcepos="119:1-119:163"><a href="https://camo.qiitausercontent.com/742d04934aeef44e5d120917e1560c0bc2073417/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3131323932392f66366631303238352d643935392d383664662d393434622d3661343661663334663262632e706e67" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F112929%2Ff6f10285-d959-86df-944b-6a46af34f2bc.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=3a4abec707b662b549a03b3b063e482f" alt="スクリーンショット 2023-05-24 13.58.52.png" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/f6f10285-d959-86df-944b-6a46af34f2bc.png" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F112929%2Ff6f10285-d959-86df-944b-6a46af34f2bc.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=1c683859d5460f775bfcfae1fdff2d45 1x" loading="lazy"></a></p>
<h2 data-sourcepos="124:1-124:9">
<span id="注意" class="fragment"></span><a href="#%E6%B3%A8%E6%84%8F"><i class="fa fa-link"></i></a>注意</h2>
<p data-sourcepos="126:1-127:247">APIとして公開すると、パスワードが漏れると、自分のGmailが全世界に公開される可能性があることを考慮のうえ使ってください。<br>
その意味では、普通のGoogleのID/Passが漏れた場合と同じですが、その場合はGoogle側で不審なログインはブロックしてくれたりしますが、このAPIの場合は不審なログインは弾かれません。</p>
<p data-sourcepos="129:1-129:212">毎回変わるデプロイIDもかなりの桁数なので、基本的にこれだけでもかなり有効なURLを見つけるのは大変なはずですがちゃんと理解した上で使ってください。</p>
<p data-sourcepos="131:1-131:146">↓以下のdeployIdは32桁超えているので、UUIDよりも特定は難しいはず。 <code>https://script.google.com/macros/s/${deployId}/exec</code></p>
</article></div></div></div></div><footer class="footer"><div class="content has-text-centered"><p>last uploaded at <!-- -->2023/11/06</p><p>© 2021 ykhirao</p></div></footer></div></div><script type="text/javascript">window.__routeInfo = JSON.parse("{\"template\":\"__react_static_root__/src/components/QiitaPost\",\"sharedHashesByProp\":{},\"data\":{\"post\":{\"rendered_body\":\"<p data-sourcepos=\\\"2:1-2:45\\\">\u4EE5\u4E0B\u306E\u3088\u3046\u306A\u69CB\u6210\u3092\u53D6\u308C\u3070\u3044\u3044\u3002</p>\\n<iframe id=\\\"qiita-embed-content__bdfc33a0b9010aa9f7d3972b6cc9dc83\\\" src=\\\"https://qiita.com/embed-contents/mermaid#qiita-embed-content__bdfc33a0b9010aa9f7d3972b6cc9dc83\\\" style=\\\"width:100%;\\\" frameborder=\\\"0\\\" scrolling=\\\"no\\\" loading=\\\"lazy\\\" data-content='{\\\"data\\\":\\\"flowchart LR\\\\nA[Gmail] -- \u53D6\u5F97 --&gt; B[Google Apps Script]\\\\nB -- API --&gt; C\\\",\\\"key\\\":\\\"ab82bed4f054297ba71e803fa9d9d937\\\"}'>\\n</iframe>\\n\\n<h2 data-sourcepos=\\\"11:1-11:24\\\">\\n<span id=\\\"gmail-api\u306E\u9762\u5012\u3055\\\" class=\\\"fragment\\\"></span><a href=\\\"#gmail-api%E3%81%AE%E9%9D%A2%E5%80%92%E3%81%95\\\"><i class=\\\"fa fa-link\\\"></i></a>Gmail API\u306E\u9762\u5012\u3055</h2>\\n<p data-sourcepos=\\\"13:1-13:86\\\">Cloud Functions\u3092\u4F7F\u3063\u305F\u3068\u3057\u3066\u3082\u3001Gmail\u5185\u5BB9\u306FAPI\u3068\u3057\u3066\u53D6\u5F97\u3067\u304D\u306A\u3044</p>\\n<p data-sourcepos=\\\"15:1-15:20\\\">CloudFunctions\u304B\u3089</p>\\n<ul data-sourcepos=\\\"17:1-20:0\\\">\\n<li data-sourcepos=\\\"17:1-17:46\\\">\u300CAPI \u3068\u30B5\u30FC\u30D3\u30B9\u300D \u300C\u8A8D\u8A3C\u60C5\u5831\u300D</li>\\n<li data-sourcepos=\\\"18:1-18:71\\\">\u300C\u8A8D\u8A3C\u60C5\u5831\u3092\u4F5C\u6210\u300D\u300COAuth \u30AF\u30E9\u30A4\u30A2\u30F3\u30C8 ID\u300D\u306E\u53D6\u5F97</li>\\n<li data-sourcepos=\\\"19:1-20:0\\\">...Client\u30B5\u30A4\u30C9\u3067Auth\u306E\u30B3\u30FC\u30C9\u66F8\u304D\u3001\u30C8\u30FC\u30AF\u30F3\u306E\u53D6\u5F97\u3057\u3066Gmail\u306EAPI\u3092\u53E9\u304F</li>\\n</ul>\\n<p data-sourcepos=\\\"21:1-21:9\\\">\u9762\u5012\u3002</p>\\n<h2 data-sourcepos=\\\"23:1-23:66\\\">\\n<span id=\\\"gas\u3092web\u30A2\u30D7\u30EA\u30B1\u30FC\u30B7\u30E7\u30F3\u3068\u3057\u3066\u516C\u958B\u3057\u3066api\u516C\u958B\\\" class=\\\"fragment\\\"></span><a href=\\\"#gas%E3%82%92web%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%A8%E3%81%97%E3%81%A6%E5%85%AC%E9%96%8B%E3%81%97%E3%81%A6api%E5%85%AC%E9%96%8B\\\"><i class=\\\"fa fa-link\\\"></i></a>Gas\u3092Web\u30A2\u30D7\u30EA\u30B1\u30FC\u30B7\u30E7\u30F3\u3068\u3057\u3066\u516C\u958B\u3057\u3066API\u516C\u958B</h2>\\n<div class=\\\"code-frame\\\" data-lang=\\\"javascript\\\" data-sourcepos=\\\"26:1-87:3\\\"><div class=\\\"highlight\\\"><pre><code><span class=\\\"kd\\\">const</span> <span class=\\\"nx\\\">FAIL</span> <span class=\\\"o\\\">=</span> <span class=\\\"p\\\">{</span> <span class=\\\"na\\\">ok</span><span class=\\\"p\\\">:</span> <span class=\\\"kc\\\">false</span><span class=\\\"p\\\">,</span> <span class=\\\"na\\\">code</span><span class=\\\"p\\\">:</span> <span class=\\\"kc\\\">null</span> <span class=\\\"p\\\">};</span>\\n\\n<span class=\\\"kd\\\">const</span> <span class=\\\"nx\\\">output</span> <span class=\\\"o\\\">=</span> <span class=\\\"nx\\\">ContentService</span><span class=\\\"p\\\">.</span><span class=\\\"nf\\\">createTextOutput</span><span class=\\\"p\\\">();</span>\\n<span class=\\\"nx\\\">output</span><span class=\\\"p\\\">.</span><span class=\\\"nf\\\">setMimeType</span><span class=\\\"p\\\">(</span><span class=\\\"nx\\\">ContentService</span><span class=\\\"p\\\">.</span><span class=\\\"nx\\\">MimeType</span><span class=\\\"p\\\">.</span><span class=\\\"nx\\\">JSON</span><span class=\\\"p\\\">);</span>\\n<span class=\\\"nx\\\">output</span><span class=\\\"p\\\">.</span><span class=\\\"nf\\\">setContent</span><span class=\\\"p\\\">(</span><span class=\\\"nx\\\">JSON</span><span class=\\\"p\\\">.</span><span class=\\\"nf\\\">stringify</span><span class=\\\"p\\\">(</span><span class=\\\"nx\\\">FAIL</span><span class=\\\"p\\\">));</span>\\n\\n<span class=\\\"cm\\\">/**\\n * \u8A8D\u8A3C\u30E9\u30D9\u30EB\u304C\u3064\u3044\u305FGmail\u3092\u53D6\u5F97\u3057\u307E\u3059\\n * query\u306E\u4F8B: https://blog.synnex.co.jp/google/gmail-gas/\\n */</span>\\n<span class=\\\"kd\\\">function</span> <span class=\\\"nf\\\">getGmail</span><span class=\\\"p\\\">(</span><span class=\\\"nx\\\">id</span><span class=\\\"p\\\">,</span> <span class=\\\"nx\\\">date</span> <span class=\\\"o\\\">=</span> <span class=\\\"dl\\\">'</span><span class=\\\"s1\\\">2023-04-17T11:00:00.000Z</span><span class=\\\"dl\\\">'</span><span class=\\\"p\\\">)</span> <span class=\\\"p\\\">{</span>\\n  <span class=\\\"c1\\\">// \u8A8D\u8A3C\u30E9\u30D9\u30EB\u306E\u4ED8\u3044\u305F\u3001\u30A2\u30AB\u30A6\u30F3\u30C8ID\u304C\u672C\u6587\u306B\u306F\u3044\u3063\u3066\u3044\u308B\u30E1\u30FC\u30EB\u30921\u4EF6\u53D6\u5F97\u3059\u308B</span>\\n  <span class=\\\"kd\\\">const</span> <span class=\\\"nx\\\">newestThread</span> <span class=\\\"o\\\">=</span> <span class=\\\"nx\\\">GmailApp</span><span class=\\\"p\\\">.</span><span class=\\\"nf\\\">search</span><span class=\\\"p\\\">(</span><span class=\\\"s2\\\">`</span><span class=\\\"p\\\">${</span><span class=\\\"nx\\\">id</span><span class=\\\"p\\\">}</span><span class=\\\"s2\\\"> label:\u30BF\u30A4\u30C8\u30EBXXX`</span><span class=\\\"p\\\">,</span> <span class=\\\"mi\\\">0</span><span class=\\\"p\\\">,</span> <span class=\\\"mi\\\">1</span><span class=\\\"p\\\">)[</span><span class=\\\"mi\\\">0</span><span class=\\\"p\\\">];</span>\\n\\n  <span class=\\\"c1\\\">// \u30B9\u30EC\u30C3\u30C9\u304C\u5B58\u5728\u3057\u306A\u3044</span>\\n  <span class=\\\"k\\\">if </span><span class=\\\"p\\\">(</span><span class=\\\"o\\\">!</span><span class=\\\"nx\\\">newestThread</span><span class=\\\"p\\\">)</span> <span class=\\\"p\\\">{</span>\\n    <span class=\\\"nx\\\">Logger</span><span class=\\\"p\\\">.</span><span class=\\\"nf\\\">log</span><span class=\\\"p\\\">(</span><span class=\\\"dl\\\">\\\"</span><span class=\\\"s2\\\">\u30B9\u30EC\u30C3\u30C9\u304C\u5B58\u5728\u3057\u307E\u305B\u3093</span><span class=\\\"dl\\\">\\\"</span><span class=\\\"p\\\">);</span>\\n    <span class=\\\"k\\\">return</span> <span class=\\\"nx\\\">output</span><span class=\\\"p\\\">;</span>\\n  <span class=\\\"p\\\">}</span>\\n\\n  <span class=\\\"kd\\\">let</span> <span class=\\\"nx\\\">messages</span> <span class=\\\"o\\\">=</span> <span class=\\\"nx\\\">newestThread</span><span class=\\\"p\\\">.</span><span class=\\\"nf\\\">getMessages</span><span class=\\\"p\\\">();</span>\\n  <span class=\\\"nx\\\">Logger</span><span class=\\\"p\\\">.</span><span class=\\\"nf\\\">log</span><span class=\\\"p\\\">(</span><span class=\\\"s2\\\">`messages length: </span><span class=\\\"p\\\">${</span><span class=\\\"nx\\\">messages</span><span class=\\\"p\\\">.</span><span class=\\\"nx\\\">length</span><span class=\\\"p\\\">}</span><span class=\\\"s2\\\">`</span><span class=\\\"p\\\">);</span>\\n  <span class=\\\"nx\\\">messages</span> <span class=\\\"o\\\">=</span> <span class=\\\"nx\\\">messages</span><span class=\\\"p\\\">.</span><span class=\\\"nf\\\">filter</span><span class=\\\"p\\\">((</span><span class=\\\"nx\\\">message</span><span class=\\\"p\\\">)</span> <span class=\\\"o\\\">=&gt;</span> <span class=\\\"nx\\\">message</span><span class=\\\"p\\\">.</span><span class=\\\"nf\\\">getPlainBody</span><span class=\\\"p\\\">().</span><span class=\\\"nf\\\">includes</span><span class=\\\"p\\\">(</span><span class=\\\"nx\\\">id</span><span class=\\\"p\\\">))</span>\\n  <span class=\\\"c1\\\">// date(Instagram\u30AF\u30EA\u30C3\u30AF\u65E5\u6642)) &lt; \u30E1\u30FC\u30EB\uFF08message\uFF09\u53D7\u4FE1\u65E5\u6642</span>\\n  <span class=\\\"nx\\\">messages</span> <span class=\\\"o\\\">=</span> <span class=\\\"nx\\\">messages</span><span class=\\\"p\\\">.</span><span class=\\\"nf\\\">filter</span><span class=\\\"p\\\">((</span><span class=\\\"nx\\\">message</span><span class=\\\"p\\\">)</span> <span class=\\\"o\\\">=&gt;</span> <span class=\\\"p\\\">(</span><span class=\\\"k\\\">new</span> <span class=\\\"nc\\\">Date</span><span class=\\\"p\\\">(</span><span class=\\\"nx\\\">date</span><span class=\\\"p\\\">)).</span><span class=\\\"nf\\\">getTime</span><span class=\\\"p\\\">()</span> <span class=\\\"o\\\">&lt;</span> <span class=\\\"nx\\\">message</span><span class=\\\"p\\\">.</span><span class=\\\"nf\\\">getDate</span><span class=\\\"p\\\">().</span><span class=\\\"nf\\\">getTime</span><span class=\\\"p\\\">());</span>\\n  <span class=\\\"nx\\\">Logger</span><span class=\\\"p\\\">.</span><span class=\\\"nf\\\">log</span><span class=\\\"p\\\">(</span><span class=\\\"s2\\\">`messages length: </span><span class=\\\"p\\\">${</span><span class=\\\"nx\\\">messages</span><span class=\\\"p\\\">.</span><span class=\\\"nx\\\">length</span><span class=\\\"p\\\">}</span><span class=\\\"s2\\\">`</span><span class=\\\"p\\\">);</span>\\n\\n  <span class=\\\"kd\\\">const</span> <span class=\\\"nx\\\">message</span> <span class=\\\"o\\\">=</span> <span class=\\\"nx\\\">messages</span><span class=\\\"p\\\">[</span><span class=\\\"mi\\\">0</span><span class=\\\"p\\\">];</span>\\n\\n  <span class=\\\"c1\\\">// \u6307\u5B9A\u6642\u9593\u3088\u308A\u524D\u306E\u30E1\u30FC\u30EB\u306F\u7121\u8996\u3059\u308B</span>\\n  <span class=\\\"k\\\">if </span><span class=\\\"p\\\">(</span><span class=\\\"o\\\">!</span><span class=\\\"nx\\\">message</span><span class=\\\"p\\\">)</span> <span class=\\\"p\\\">{</span>\\n    <span class=\\\"nx\\\">Logger</span><span class=\\\"p\\\">.</span><span class=\\\"nf\\\">log</span><span class=\\\"p\\\">(</span><span class=\\\"dl\\\">\\\"</span><span class=\\\"s2\\\">\u671F\u9593\u5185\u306E\u30E1\u30FC\u30EB\u304C\u5B58\u5728\u3057\u307E\u305B\u3093</span><span class=\\\"dl\\\">\\\"</span><span class=\\\"p\\\">);</span>\\n    <span class=\\\"k\\\">return</span> <span class=\\\"nx\\\">output</span><span class=\\\"p\\\">;</span>\\n  <span class=\\\"p\\\">}</span>\\n\\n  <span class=\\\"kd\\\">const</span> <span class=\\\"nx\\\">code</span> <span class=\\\"o\\\">=</span> <span class=\\\"nf\\\">getCode</span><span class=\\\"p\\\">(</span><span class=\\\"nx\\\">message</span><span class=\\\"p\\\">.</span><span class=\\\"nf\\\">getPlainBody</span><span class=\\\"p\\\">());</span>\\n  <span class=\\\"nx\\\">Logger</span><span class=\\\"p\\\">.</span><span class=\\\"nf\\\">log</span><span class=\\\"p\\\">(</span><span class=\\\"nx\\\">code</span><span class=\\\"p\\\">)</span>\\n\\n  <span class=\\\"nx\\\">output</span><span class=\\\"p\\\">.</span><span class=\\\"nf\\\">setContent</span><span class=\\\"p\\\">(</span><span class=\\\"nx\\\">JSON</span><span class=\\\"p\\\">.</span><span class=\\\"nf\\\">stringify</span><span class=\\\"p\\\">({</span> <span class=\\\"na\\\">ok</span><span class=\\\"p\\\">:</span> <span class=\\\"kc\\\">true</span><span class=\\\"p\\\">,</span> <span class=\\\"nx\\\">code</span> <span class=\\\"p\\\">}))</span>\\n  <span class=\\\"k\\\">return</span> <span class=\\\"nx\\\">output</span><span class=\\\"p\\\">;</span>\\n<span class=\\\"p\\\">}</span>\\n\\n<span class=\\\"cm\\\">/**\\n * param:  {\\n *   \\\"id\\\": \\\"\\\",\\n *   \\\"data\\\": \\\"2023-04-17T16:18:00.173Z\\\",\\n *   \\\"pass\\\": \\\"\u30D9\u30A2\u30E9\u30FC\u30C8\u30FC\u30AF\u30F3\u307F\u305F\u3044\u306A\u306E\\\"\\n * }\\n */</span>\\n<span class=\\\"kd\\\">function</span> <span class=\\\"nf\\\">doGet</span><span class=\\\"p\\\">(</span><span class=\\\"nx\\\">e</span><span class=\\\"p\\\">)</span> <span class=\\\"p\\\">{</span>\\n  <span class=\\\"nx\\\">Logger</span><span class=\\\"p\\\">.</span><span class=\\\"nf\\\">log</span><span class=\\\"p\\\">(</span><span class=\\\"nx\\\">e</span><span class=\\\"p\\\">);</span>\\n  <span class=\\\"kd\\\">const</span> <span class=\\\"nx\\\">params</span> <span class=\\\"o\\\">=</span> <span class=\\\"nx\\\">e</span><span class=\\\"p\\\">.</span><span class=\\\"nx\\\">parameter</span><span class=\\\"p\\\">;</span>\\n  <span class=\\\"k\\\">if </span><span class=\\\"p\\\">(</span><span class=\\\"nx\\\">params</span><span class=\\\"p\\\">?.</span><span class=\\\"nx\\\">pass</span> <span class=\\\"o\\\">!==</span> <span class=\\\"dl\\\">'</span><span class=\\\"s1\\\">\u30D9\u30A2\u30E9\u30FC\u30C8\u30FC\u30AF\u30F3\u307F\u305F\u3044\u306A\u306E</span><span class=\\\"dl\\\">'</span> <span class=\\\"p\\\">)</span> <span class=\\\"p\\\">{</span>\\n    <span class=\\\"nx\\\">Logger</span><span class=\\\"p\\\">.</span><span class=\\\"nf\\\">log</span><span class=\\\"p\\\">(</span><span class=\\\"dl\\\">\\\"</span><span class=\\\"s2\\\">pass\u304C\u9593\u9055\u3044\u3067\u3059\u3002</span><span class=\\\"dl\\\">\\\"</span><span class=\\\"p\\\">);</span>\\n    <span class=\\\"nx\\\">output</span><span class=\\\"p\\\">.</span><span class=\\\"nf\\\">setContent</span><span class=\\\"p\\\">(</span><span class=\\\"nx\\\">JSON</span><span class=\\\"p\\\">.</span><span class=\\\"nf\\\">stringify</span><span class=\\\"p\\\">(</span><span class=\\\"nx\\\">FAIL</span><span class=\\\"p\\\">));</span>\\n    <span class=\\\"k\\\">return</span> <span class=\\\"nx\\\">output</span><span class=\\\"p\\\">;</span>\\n  <span class=\\\"p\\\">}</span>\\n\\n  <span class=\\\"k\\\">return</span> <span class=\\\"nf\\\">getGmail</span><span class=\\\"p\\\">(</span><span class=\\\"nx\\\">params</span><span class=\\\"p\\\">?.</span><span class=\\\"nx\\\">id</span><span class=\\\"p\\\">,</span> <span class=\\\"nx\\\">params</span><span class=\\\"p\\\">?.</span><span class=\\\"nx\\\">date</span><span class=\\\"p\\\">);</span>\\n<span class=\\\"p\\\">}</span>\\n</code></pre></div></div>\\n<p data-sourcepos=\\\"89:1-89:15\\\">Client\u30B5\u30A4\u30C9</p>\\n<div class=\\\"code-frame\\\" data-lang=\\\"js\\\" data-sourcepos=\\\"91:1-103:3\\\"><div class=\\\"highlight\\\"><pre><code><span class=\\\"err\\\">\u3000\u3000</span><span class=\\\"kd\\\">const</span> <span class=\\\"nx\\\">deployId</span> <span class=\\\"o\\\">=</span> <span class=\\\"dl\\\">'</span><span class=\\\"s1\\\">GAS\u753B\u9762\u304B\u3089\u30C7\u30D7\u30ED\u30A4\u3057\u305F\u3068\u304D\u306EID_\u30C7\u30D7\u30ED\u30A4\u3059\u308B\u305F\u3073\u306B\u5909\u308F\u308B</span><span class=\\\"dl\\\">'</span><span class=\\\"p\\\">;</span>\\n  <span class=\\\"kd\\\">const</span> <span class=\\\"nx\\\">res</span> <span class=\\\"o\\\">=</span> <span class=\\\"k\\\">await</span> <span class=\\\"nx\\\">axios</span><span class=\\\"p\\\">.</span><span class=\\\"kd\\\">get</span><span class=\\\"o\\\">&lt;</span><span class=\\\"p\\\">{</span> <span class=\\\"na\\\">ok</span><span class=\\\"p\\\">:</span> <span class=\\\"kc\\\">true</span><span class=\\\"p\\\">,</span> <span class=\\\"na\\\">code</span><span class=\\\"p\\\">:</span> <span class=\\\"nx\\\">string</span> <span class=\\\"p\\\">}</span><span class=\\\"o\\\">&gt;</span><span class=\\\"p\\\">(</span>\\n    <span class=\\\"s2\\\">`https://script.google.com/macros/s/</span><span class=\\\"p\\\">${</span><span class=\\\"nx\\\">deployId</span><span class=\\\"p\\\">}</span><span class=\\\"s2\\\">/exec`</span><span class=\\\"p\\\">,</span>\\n    <span class=\\\"p\\\">{</span>\\n      <span class=\\\"na\\\">params</span><span class=\\\"p\\\">:</span> <span class=\\\"p\\\">{</span>\\n        <span class=\\\"na\\\">pass</span><span class=\\\"p\\\">:</span> <span class=\\\"dl\\\">'</span><span class=\\\"s1\\\">\u30D9\u30A2\u30E9\u30FC\u30C8\u30FC\u30AF\u30F3\u307F\u305F\u3044\u306A\u306E</span><span class=\\\"dl\\\">'</span><span class=\\\"p\\\">,</span>\\n        <span class=\\\"nx\\\">date</span><span class=\\\"p\\\">,</span>\\n        <span class=\\\"nx\\\">id</span><span class=\\\"p\\\">,</span>\\n      <span class=\\\"p\\\">},</span>\\n    <span class=\\\"p\\\">}</span>\\n  <span class=\\\"p\\\">);</span>\\n</code></pre></div></div>\\n<p data-sourcepos=\\\"105:1-105:238\\\">\u30D9\u30A2\u30E9\u30FC\u30C8\u30FC\u30AF\u30F3\u307F\u305F\u3044\u306A\u306E\u306F\u4EFB\u610F\u306E\u6587\u5B57\u5217128\u6587\u5B57\u3068\u304B\u9069\u5F53\u306B\u30B8\u30A7\u30CD\u30EC\u30FC\u30C8\u3057\u305F\u3082\u306E\u3092\u4F7F\u3063\u3066\u3001\u7D76\u5BFE\u306B\u63A8\u6E2C\u3067\u304D\u306A\u3044\u3082\u306E\u306B\u3057\u3066\u304F\u3060\u3055\u3044\u3002UUID\u306B\u5408\u308F\u305B\u308B\u3068\u82F1\u6570\u5B57\u306E\uFF13\uFF12\u6841\u3067\u3059\u3002</p>\\n<p data-sourcepos=\\\"107:1-107:164\\\">UUID\u304C16\u9032\u6570\u306732\u6841\u3067\u3059\u304C\u3001\u7279\u5B9A\u3055\u305B\u308B\u306B\u306F\u3069\u308C\u304F\u3089\u3044\u306E\u6642\u9593\u304C\u304B\u304B\u308B\u304B\u3092\u793A\u3057\u305F\u8A08\u7B97\u3092\u53C2\u8003\u306B\u3059\u308B\u306E\u304C\u3044\u3044\u304B\u3068\u601D\u3044\u307E\u3059\u3002</p>\\n<p data-sourcepos=\\\"109:1-109:54\\\"><iframe id=\\\"qiita-embed-content__c93389a25d1f021fae5a1de310b3ff24\\\" src=\\\"https://qiita.com/embed-contents/link-card#qiita-embed-content__c93389a25d1f021fae5a1de310b3ff24\\\" data-content=\\\"https%3A%2F%2Fzenn.dev%2Fkiyocy24%2Farticles%2Fuuid-duplicate-time\\\" frameborder=\\\"0\\\" scrolling=\\\"no\\\" loading=\\\"lazy\\\" style=\\\"width:100%;\\\" height=\\\"29\\\">\\n</iframe>\\n</p>\\n<p data-sourcepos=\\\"111:1-111:36\\\">\u30C7\u30D7\u30ED\u30A4\u65B9\u6CD5\u306F\u3053\u3093\u306A\u611F\u3058</p>\\n<p data-sourcepos=\\\"113:1-113:69\\\">\u4E0A\u90E8\u306E\u30C7\u30D7\u30ED\u30A4\u30DC\u30BF\u30F3\u304B\u3089\u30A6\u30A7\u30D6\u30A2\u30D7\u30EA\u3068\u3057\u3066\u516C\u958B</p>\\n<p data-sourcepos=\\\"115:1-115:163\\\"><a href=\\\"https://camo.qiitausercontent.com/e84bf0cff05cb785a7e7ac24fbffd2709b37cfdc/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3131323932392f37653834656137392d363632372d323064352d353431622d3566353439363834636463342e706e67\\\" target=\\\"_blank\\\" rel=\\\"nofollow noopener\\\"><img src=\\\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F112929%2F7e84ea79-6627-20d5-541b-5f549684cdc4.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=359f49a8e47382453802bf68aa0d96b7\\\" alt=\\\"\u30B9\u30AF\u30EA\u30FC\u30F3\u30B7\u30E7\u30C3\u30C8 2023-05-24 13.58.21.png\\\" data-canonical-src=\\\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/7e84ea79-6627-20d5-541b-5f549684cdc4.png\\\" srcset=\\\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F112929%2F7e84ea79-6627-20d5-541b-5f549684cdc4.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=1396d90090e650a88db1100c8ccde5f8 1x\\\" loading=\\\"lazy\\\"></a></p>\\n<p data-sourcepos=\\\"117:1-117:38\\\">\u3082\u308D\u3082\u308D\u8A8D\u8A3C\u3067OK\u3092\u62BC\u3057\u305F\u3089</p>\\n<p data-sourcepos=\\\"119:1-119:163\\\"><a href=\\\"https://camo.qiitausercontent.com/742d04934aeef44e5d120917e1560c0bc2073417/68747470733a2f2f71696974612d696d6167652d73746f72652e73332e61702d6e6f727468656173742d312e616d617a6f6e6177732e636f6d2f302f3131323932392f66366631303238352d643935392d383664662d393434622d3661343661663334663262632e706e67\\\" target=\\\"_blank\\\" rel=\\\"nofollow noopener\\\"><img src=\\\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F112929%2Ff6f10285-d959-86df-944b-6a46af34f2bc.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=3a4abec707b662b549a03b3b063e482f\\\" alt=\\\"\u30B9\u30AF\u30EA\u30FC\u30F3\u30B7\u30E7\u30C3\u30C8 2023-05-24 13.58.52.png\\\" data-canonical-src=\\\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/f6f10285-d959-86df-944b-6a46af34f2bc.png\\\" srcset=\\\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F112929%2Ff6f10285-d959-86df-944b-6a46af34f2bc.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=1c683859d5460f775bfcfae1fdff2d45 1x\\\" loading=\\\"lazy\\\"></a></p>\\n<h2 data-sourcepos=\\\"124:1-124:9\\\">\\n<span id=\\\"\u6CE8\u610F\\\" class=\\\"fragment\\\"></span><a href=\\\"#%E6%B3%A8%E6%84%8F\\\"><i class=\\\"fa fa-link\\\"></i></a>\u6CE8\u610F</h2>\\n<p data-sourcepos=\\\"126:1-127:247\\\">API\u3068\u3057\u3066\u516C\u958B\u3059\u308B\u3068\u3001\u30D1\u30B9\u30EF\u30FC\u30C9\u304C\u6F0F\u308C\u308B\u3068\u3001\u81EA\u5206\u306EGmail\u304C\u5168\u4E16\u754C\u306B\u516C\u958B\u3055\u308C\u308B\u53EF\u80FD\u6027\u304C\u3042\u308B\u3053\u3068\u3092\u8003\u616E\u306E\u3046\u3048\u4F7F\u3063\u3066\u304F\u3060\u3055\u3044\u3002<br>\\n\u305D\u306E\u610F\u5473\u3067\u306F\u3001\u666E\u901A\u306EGoogle\u306EID/Pass\u304C\u6F0F\u308C\u305F\u5834\u5408\u3068\u540C\u3058\u3067\u3059\u304C\u3001\u305D\u306E\u5834\u5408\u306FGoogle\u5074\u3067\u4E0D\u5BE9\u306A\u30ED\u30B0\u30A4\u30F3\u306F\u30D6\u30ED\u30C3\u30AF\u3057\u3066\u304F\u308C\u305F\u308A\u3057\u307E\u3059\u304C\u3001\u3053\u306EAPI\u306E\u5834\u5408\u306F\u4E0D\u5BE9\u306A\u30ED\u30B0\u30A4\u30F3\u306F\u5F3E\u304B\u308C\u307E\u305B\u3093\u3002</p>\\n<p data-sourcepos=\\\"129:1-129:212\\\">\u6BCE\u56DE\u5909\u308F\u308B\u30C7\u30D7\u30ED\u30A4ID\u3082\u304B\u306A\u308A\u306E\u6841\u6570\u306A\u306E\u3067\u3001\u57FA\u672C\u7684\u306B\u3053\u308C\u3060\u3051\u3067\u3082\u304B\u306A\u308A\u6709\u52B9\u306AURL\u3092\u898B\u3064\u3051\u308B\u306E\u306F\u5927\u5909\u306A\u306F\u305A\u3067\u3059\u304C\u3061\u3083\u3093\u3068\u7406\u89E3\u3057\u305F\u4E0A\u3067\u4F7F\u3063\u3066\u304F\u3060\u3055\u3044\u3002</p>\\n<p data-sourcepos=\\\"131:1-131:146\\\">\u2193\u4EE5\u4E0B\u306EdeployId\u306F32\u6841\u8D85\u3048\u3066\u3044\u308B\u306E\u3067\u3001UUID\u3088\u308A\u3082\u7279\u5B9A\u306F\u96E3\u3057\u3044\u306F\u305A\u3002 <code>https://script.google.com/macros/s/${deployId}/exec</code></p>\\n\",\"body\":\"\\n\u4EE5\u4E0B\u306E\u3088\u3046\u306A\u69CB\u6210\u3092\u53D6\u308C\u3070\u3044\u3044\u3002\\n\\n```mermaid\\nflowchart LR\\nA[Gmail] -- \u53D6\u5F97 --> B[Google Apps Script]\\nB -- API --> C\\n```\\n\\n\\n## Gmail API\u306E\u9762\u5012\u3055\\n\\nCloud Functions\u3092\u4F7F\u3063\u305F\u3068\u3057\u3066\u3082\u3001Gmail\u5185\u5BB9\u306FAPI\u3068\u3057\u3066\u53D6\u5F97\u3067\u304D\u306A\u3044\\n\\nCloudFunctions\u304B\u3089\\n\\n* \u300CAPI \u3068\u30B5\u30FC\u30D3\u30B9\u300D \u300C\u8A8D\u8A3C\u60C5\u5831\u300D\\n* \u300C\u8A8D\u8A3C\u60C5\u5831\u3092\u4F5C\u6210\u300D\u300COAuth \u30AF\u30E9\u30A4\u30A2\u30F3\u30C8 ID\u300D\u306E\u53D6\u5F97\\n* ...Client\u30B5\u30A4\u30C9\u3067Auth\u306E\u30B3\u30FC\u30C9\u66F8\u304D\u3001\u30C8\u30FC\u30AF\u30F3\u306E\u53D6\u5F97\u3057\u3066Gmail\u306EAPI\u3092\u53E9\u304F\\n\\n\u9762\u5012\u3002\\n\\n## Gas\u3092Web\u30A2\u30D7\u30EA\u30B1\u30FC\u30B7\u30E7\u30F3\u3068\u3057\u3066\u516C\u958B\u3057\u3066API\u516C\u958B\\n\\n\\n```javascript\\nconst FAIL = { ok: false, code: null };\\n\\nconst output = ContentService.createTextOutput();\\noutput.setMimeType(ContentService.MimeType.JSON);\\noutput.setContent(JSON.stringify(FAIL));\\n\\n/**\\n * \u8A8D\u8A3C\u30E9\u30D9\u30EB\u304C\u3064\u3044\u305FGmail\u3092\u53D6\u5F97\u3057\u307E\u3059\\n * query\u306E\u4F8B: https://blog.synnex.co.jp/google/gmail-gas/\\n */\\nfunction getGmail(id, date = '2023-04-17T11:00:00.000Z') {\\n  // \u8A8D\u8A3C\u30E9\u30D9\u30EB\u306E\u4ED8\u3044\u305F\u3001\u30A2\u30AB\u30A6\u30F3\u30C8ID\u304C\u672C\u6587\u306B\u306F\u3044\u3063\u3066\u3044\u308B\u30E1\u30FC\u30EB\u30921\u4EF6\u53D6\u5F97\u3059\u308B\\n  const newestThread = GmailApp.search(`${id} label:\u30BF\u30A4\u30C8\u30EBXXX`, 0, 1)[0];\\n\\n  // \u30B9\u30EC\u30C3\u30C9\u304C\u5B58\u5728\u3057\u306A\u3044\\n  if (!newestThread) {\\n    Logger.log(\\\"\u30B9\u30EC\u30C3\u30C9\u304C\u5B58\u5728\u3057\u307E\u305B\u3093\\\");\\n    return output;\\n  }\\n\\n  let messages = newestThread.getMessages();\\n  Logger.log(`messages length: ${messages.length}`);\\n  messages = messages.filter((message) => message.getPlainBody().includes(id))\\n  // date(Instagram\u30AF\u30EA\u30C3\u30AF\u65E5\u6642)) < \u30E1\u30FC\u30EB\uFF08message\uFF09\u53D7\u4FE1\u65E5\u6642\\n  messages = messages.filter((message) => (new Date(date)).getTime() < message.getDate().getTime());\\n  Logger.log(`messages length: ${messages.length}`);\\n\\n  const message = messages[0];\\n\\n  // \u6307\u5B9A\u6642\u9593\u3088\u308A\u524D\u306E\u30E1\u30FC\u30EB\u306F\u7121\u8996\u3059\u308B\\n  if (!message) {\\n    Logger.log(\\\"\u671F\u9593\u5185\u306E\u30E1\u30FC\u30EB\u304C\u5B58\u5728\u3057\u307E\u305B\u3093\\\");\\n    return output;\\n  }\\n\\n  const code = getCode(message.getPlainBody());\\n  Logger.log(code)\\n\\n  output.setContent(JSON.stringify({ ok: true, code }))\\n  return output;\\n}\\n\\n/**\\n * param:  {\\n *   \\\"id\\\": \\\"\\\",\\n *   \\\"data\\\": \\\"2023-04-17T16:18:00.173Z\\\",\\n *   \\\"pass\\\": \\\"\u30D9\u30A2\u30E9\u30FC\u30C8\u30FC\u30AF\u30F3\u307F\u305F\u3044\u306A\u306E\\\"\\n * }\\n */\\nfunction doGet(e) {\\n  Logger.log(e);\\n  const params = e.parameter;\\n  if (params?.pass !== '\u30D9\u30A2\u30E9\u30FC\u30C8\u30FC\u30AF\u30F3\u307F\u305F\u3044\u306A\u306E' ) {\\n    Logger.log(\\\"pass\u304C\u9593\u9055\u3044\u3067\u3059\u3002\\\");\\n    output.setContent(JSON.stringify(FAIL));\\n    return output;\\n  }\\n\\n  return getGmail(params?.id, params?.date);\\n}\\n```\\n\\nClient\u30B5\u30A4\u30C9\\n\\n```js\\n\u3000\u3000const deployId = 'GAS\u753B\u9762\u304B\u3089\u30C7\u30D7\u30ED\u30A4\u3057\u305F\u3068\u304D\u306EID_\u30C7\u30D7\u30ED\u30A4\u3059\u308B\u305F\u3073\u306B\u5909\u308F\u308B';\\n  const res = await axios.get<{ ok: true, code: string }>(\\n    `https://script.google.com/macros/s/${deployId}/exec`,\\n    {\\n      params: {\\n        pass: '\u30D9\u30A2\u30E9\u30FC\u30C8\u30FC\u30AF\u30F3\u307F\u305F\u3044\u306A\u306E',\\n        date,\\n        id,\\n      },\\n    }\\n  );\\n```\\n\\n\u30D9\u30A2\u30E9\u30FC\u30C8\u30FC\u30AF\u30F3\u307F\u305F\u3044\u306A\u306E\u306F\u4EFB\u610F\u306E\u6587\u5B57\u5217128\u6587\u5B57\u3068\u304B\u9069\u5F53\u306B\u30B8\u30A7\u30CD\u30EC\u30FC\u30C8\u3057\u305F\u3082\u306E\u3092\u4F7F\u3063\u3066\u3001\u7D76\u5BFE\u306B\u63A8\u6E2C\u3067\u304D\u306A\u3044\u3082\u306E\u306B\u3057\u3066\u304F\u3060\u3055\u3044\u3002UUID\u306B\u5408\u308F\u305B\u308B\u3068\u82F1\u6570\u5B57\u306E\uFF13\uFF12\u6841\u3067\u3059\u3002\\n\\nUUID\u304C16\u9032\u6570\u306732\u6841\u3067\u3059\u304C\u3001\u7279\u5B9A\u3055\u305B\u308B\u306B\u306F\u3069\u308C\u304F\u3089\u3044\u306E\u6642\u9593\u304C\u304B\u304B\u308B\u304B\u3092\u793A\u3057\u305F\u8A08\u7B97\u3092\u53C2\u8003\u306B\u3059\u308B\u306E\u304C\u3044\u3044\u304B\u3068\u601D\u3044\u307E\u3059\u3002\\n\\nhttps://zenn.dev/kiyocy24/articles/uuid-duplicate-time\\n\\n\u30C7\u30D7\u30ED\u30A4\u65B9\u6CD5\u306F\u3053\u3093\u306A\u611F\u3058\\n\\n\u4E0A\u90E8\u306E\u30C7\u30D7\u30ED\u30A4\u30DC\u30BF\u30F3\u304B\u3089\u30A6\u30A7\u30D6\u30A2\u30D7\u30EA\u3068\u3057\u3066\u516C\u958B\\n\\n![\u30B9\u30AF\u30EA\u30FC\u30F3\u30B7\u30E7\u30C3\u30C8 2023-05-24 13.58.21.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/7e84ea79-6627-20d5-541b-5f549684cdc4.png)\\n\\n\u3082\u308D\u3082\u308D\u8A8D\u8A3C\u3067OK\u3092\u62BC\u3057\u305F\u3089\\n\\n![\u30B9\u30AF\u30EA\u30FC\u30F3\u30B7\u30E7\u30C3\u30C8 2023-05-24 13.58.52.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/f6f10285-d959-86df-944b-6a46af34f2bc.png)\\n\\n\\n\\n\\n## \u6CE8\u610F\\n\\nAPI\u3068\u3057\u3066\u516C\u958B\u3059\u308B\u3068\u3001\u30D1\u30B9\u30EF\u30FC\u30C9\u304C\u6F0F\u308C\u308B\u3068\u3001\u81EA\u5206\u306EGmail\u304C\u5168\u4E16\u754C\u306B\u516C\u958B\u3055\u308C\u308B\u53EF\u80FD\u6027\u304C\u3042\u308B\u3053\u3068\u3092\u8003\u616E\u306E\u3046\u3048\u4F7F\u3063\u3066\u304F\u3060\u3055\u3044\u3002\\n\u305D\u306E\u610F\u5473\u3067\u306F\u3001\u666E\u901A\u306EGoogle\u306EID/Pass\u304C\u6F0F\u308C\u305F\u5834\u5408\u3068\u540C\u3058\u3067\u3059\u304C\u3001\u305D\u306E\u5834\u5408\u306FGoogle\u5074\u3067\u4E0D\u5BE9\u306A\u30ED\u30B0\u30A4\u30F3\u306F\u30D6\u30ED\u30C3\u30AF\u3057\u3066\u304F\u308C\u305F\u308A\u3057\u307E\u3059\u304C\u3001\u3053\u306EAPI\u306E\u5834\u5408\u306F\u4E0D\u5BE9\u306A\u30ED\u30B0\u30A4\u30F3\u306F\u5F3E\u304B\u308C\u307E\u305B\u3093\u3002\\n\\n\u6BCE\u56DE\u5909\u308F\u308B\u30C7\u30D7\u30ED\u30A4ID\u3082\u304B\u306A\u308A\u306E\u6841\u6570\u306A\u306E\u3067\u3001\u57FA\u672C\u7684\u306B\u3053\u308C\u3060\u3051\u3067\u3082\u304B\u306A\u308A\u6709\u52B9\u306AURL\u3092\u898B\u3064\u3051\u308B\u306E\u306F\u5927\u5909\u306A\u306F\u305A\u3067\u3059\u304C\u3061\u3083\u3093\u3068\u7406\u89E3\u3057\u305F\u4E0A\u3067\u4F7F\u3063\u3066\u304F\u3060\u3055\u3044\u3002\\n\\n\u2193\u4EE5\u4E0B\u306EdeployId\u306F32\u6841\u8D85\u3048\u3066\u3044\u308B\u306E\u3067\u3001UUID\u3088\u308A\u3082\u7279\u5B9A\u306F\u96E3\u3057\u3044\u306F\u305A\u3002 `https://script.google.com/macros/s/${deployId}/exec`\\n\\n\\n\\n\\n\\n\\n\",\"coediting\":false,\"comments_count\":0,\"created_at\":\"2023-05-24T14:03:41+09:00\",\"group\":null,\"id\":\"e8ce93223175a043a69a\",\"likes_count\":0,\"private\":false,\"reactions_count\":0,\"stocks_count\":1,\"tags\":[{\"name\":\"JavaScript\",\"versions\":[]},{\"name\":\"GoogleAppsScript\",\"versions\":[]},{\"name\":\"GAS\",\"versions\":[]},{\"name\":\"Gmail\",\"versions\":[]},{\"name\":\"TypeScript\",\"versions\":[]}],\"title\":\"\u3010GAS\u3011Gmail API\u3092\u4F7F\u308F\u305A\u306BGmail\u3092API\u7D4C\u7531\u3067\u53D6\u5F97\u3059\u308B\",\"updated_at\":\"2023-05-24T14:07:22+09:00\",\"url\":\"https://qiita.com/ykhirao/items/e8ce93223175a043a69a\",\"user\":{\"description\":\"Web Developer From 2016.\\r\\nPHP/Laravel && React/TypeScript/Node.js\\r\\n\\r\\n\u696D\u52D9\u59D4\u8A17\u306E\u4F9D\u983C\u3068\u304B\u306FWantedly\u3068\u304B\u304B\u3089\u3067\u304A\u9858\u3044\u3057\u307E\u3059\uFF01\",\"facebook_id\":\"\",\"followees_count\":38,\"followers_count\":99,\"github_login_name\":\"ykhirao\",\"id\":\"ykhirao\",\"items_count\":71,\"linkedin_id\":\"\",\"location\":\"Tokyo, Japan\",\"name\":\"yk\",\"organization\":\"\",\"permanent_id\":112929,\"profile_image_url\":\"https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/112929/profile-images/1639030792\",\"team_only\":false,\"twitter_screen_name\":\"ykhirao\",\"website_url\":\"https://www.wantedly.com/id/ykhirao\"},\"page_views_count\":null,\"team_membership\":null,\"organization_url_name\":null,\"slide\":false}},\"path\":\"posts/e8ce93223175a043a69a\",\"sharedData\":{},\"siteData\":{\"updatedAt\":\"2023/11/06\"}}");</script><script defer="" type="text/javascript" src="/templates/styles.60fb0704.js"></script><script defer="" type="text/javascript" src="/templates/vendors~main.991a9778.js"></script><script defer="" type="text/javascript" src="/main.e4c894d8.js"></script></body></html>